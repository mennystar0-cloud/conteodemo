<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CKLASS — Catálogo + Existencias (con mapeo de columnas)</title>
<style>
  :root{--b:#111;--m:#f6f7f9;--bd:#d0d7de;--mut:#6b7280}
  *{box-sizing:border-box} body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--m);color:var(--b);margin:0}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px;font-size:24px} h2{margin:0 0 8px;font-size:18px}
  p{margin:0 0 10px;color:var(--mut)}
  .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .8rem;border-radius:.5rem;border:1px solid var(--bd);background:#fff;cursor:pointer}
  .btn:active{transform:scale(.97);opacity:.9}
  .btn[disabled]{opacity:.6;pointer-events:none}
  input,textarea,select{width:100%;padding:.6rem;border:1px solid var(--bd);border-radius:.5rem;font-family:inherit}
  textarea{min-height:160px;white-space:pre}
  .card{background:#fff;border:1px solid var(--bd);border-radius:.75rem;padding:1rem;margin-top:12px}
  table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--bd);border-radius:.5rem;overflow:hidden}
  th,td{border-bottom:1px solid #eef2f7;padding:.45rem .55rem;font-size:.9rem;text-align:left}
  th{background:#f8fafc} tfoot td{font-weight:600;background:#fafafa}
  .ok{color:#047857}.err{color:#b91c1c}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .pill{border:1px solid var(--bd);border-radius:.5rem;padding:.15rem .4rem;background:#fff}
  .hint{font-size:.85rem;color:#6b7280}
</style>
</head>
<body>
<div class="wrap">
  <h1>CKLASS — Catálogo + Existencias (con mapeo de columnas)</h1>
  <p>1) Cargar Catálogo Master desde <code>./static/catalogo-master.csv</code> → 2) Mapear columnas si hace falta → 3) Pegar existencias.</p>

  <!-- CARGA -->
  <div class="card">
    <h2>1) Cargar Catálogo</h2>
    <div class="row" style="margin-bottom:.5rem">
      <button id="btnLoad" class="btn">Cargar CSV</button>
      <button id="btnBust" class="btn" title="Evita caché agregando ?v=timestamp">Forzar recarga</button>
      <span id="status" class="pill">—</span>
    </div>
    <label class="mono" style="display:block;margin-bottom:.25rem">Ruta</label>
    <input id="path" value="./static/catalogo-master.csv" />
    <div class="row" style="margin-top:.5rem;font-size:.92rem">
      <div><b>HTTP:</b> <span id="http">—</span></div>
      <div><b>Enc:</b> <span id="enc">—</span></div>
      <div><b>Sep:</b> <span id="sep">—</span></div>
      <div><b>Headers:</b> <span id="hdrs">—</span></div>
      <div><b>Filas:</b> <span id="rows">—</span></div>
    </div>
  </div>

  <!-- MAPEADOR DE COLUMNAS -->
  <div id="mapperCard" class="card" style="display:none">
    <h2>2) Mapear columnas (si no se detectaron automáticamente)</h2>
    <p class="hint">Selecciona qué columna del CSV corresponde a cada campo requerido. Luego pulsa <b>Confirmar mapeo</b>.</p>
    <div class="row">
      <div style="flex:1">
        <label>Modelo</label>
        <select id="selMOD"></select>
      </div>
      <div style="flex:1">
        <label>Color</label>
        <select id="selCOLOR"></select>
      </div>
      <div style="flex:1">
        <label>Talla</label>
        <select id="selTALLA"></select>
      </div>
    </div>
    <div class="row" style="margin-top:.5rem">
      <button id="btnConfirmMap" class="btn">Confirmar mapeo</button>
      <span id="mapStatus" class="pill">—</span>
    </div>
  </div>

  <!-- PEGAR EXISTENCIAS -->
  <div class="card">
    <h2>3) Pegar existencias (inventario teórico)</h2>
    <p class="mono">Formato por línea: <code>MODELO, COLOR ..... TALLA ..... CANT</code></p>
    <pre class="mono" style="margin:.25rem 0 .5rem;background:#f8fafc;padding:.5rem;border:1px solid #e5e7eb;border-radius:.5rem">
601-16,NEGRO              270          1
601-30,ROSA               260          1
601-30,ROSA               265          1
619-97,NEGRO              GEX          1
</pre>
    <textarea id="paste" placeholder="Pega aquí…"></textarea>
    <div class="row" style="margin-top:.5rem">
      <button id="btnProcesar" class="btn" disabled>Procesar existencias</button>
      <button id="btnExportTeorico" class="btn" disabled>Exportar CSV (teórico)</button>
      <span id="resumenTeo">—</span>
    </div>
  </div>

  <!-- RESULTADO TEÓRICO -->
  <div class="card">
    <h2>4) Existencias teóricas</h2>
    <div class="row">
      <div><b>Claves:</b> <span id="nClaves">0</span></div>
      <div><b>Piezas:</b> <span id="nPiezas">0</span></div>
      <div><b>Líneas pegadas:</b> <span id="nLineas">0</span></div>
      <div><b>Omitidos:</b> <span id="nOmitidos">0</span></div>
    </div>
    <div style="overflow:auto;margin-top:.5rem">
      <table>
        <thead>
          <tr><th>Modelo</th><th>Color</th><th>Talla</th><th style="text-align:right">Cantidad</th></tr>
        </thead>
        <tbody id="tbodyTeo"><tr><td colspan="4">—</td></tr></tbody>
        <tfoot>
          <tr><td colspan="3" style="text-align:right">TOTAL</td><td id="totTeo" style="text-align:right">0</td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const norm = s => (s??'').normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').trim().toUpperCase();

  /* ---------- CSV utils ---------- */
  function detectCSV(text){
    const lines = text.split(/\\r\\n|\\n|\\r/);
    const first = lines[0] || '';
    const m = /^sep\\s*=\\s*([,;|\\t])\\s*$/i.exec(first);
    if (m) return { delim: m[1], dropFirst: true };
    const sample = lines.slice(0, 200).join('\\n');
    const counts = { '\\t':(sample.match(/\\t/g)||[]).length, ';':(sample.match(/;/g)||[]).length, ',':(sample.match(/,/g)||[]).length, '|':(sample.match(/\\|/g)||[]).length };
    const delim = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ',';
    return { delim, dropFirst:false };
  }
  function splitCSV(line, d){
    const out=[]; let cur='', q=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch === '"'){ if(q && line[i+1] === '"'){ cur+='"'; i++; } else { q=!q; } }
      else if (!q && ch === d){ out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur); return out;
  }
  async function fetchDecoded(url){
    const resp = await fetch(url, { cache:'no-store' });
    const buf = await resp.arrayBuffer();
    const b = new Uint8Array(buf);
    let enc='utf-8';
    if (b.length>=2){
      if (b[0]===0xFF && b[1]===0xFE) enc='utf-16le';
      else if (b[0]===0xFE && b[1]===0xFF) enc='utf-16be';
      else if (b.length>=3 && b[0]===0xEF && b[1]===0xBB && b[2]===0xBF) enc='utf-8';
    }
    if (enc==='utf-8'){
      let zeros=0; for(let i=0;i<Math.min(b.length,4096);i++) if(b[i]===0) zeros++;
      if (zeros > b.length/10) enc='utf-16le';
    }
    let text; try{ text=new TextDecoder(enc).decode(buf); }catch{ enc='windows-1252'; text=new TextDecoder(enc).decode(buf); }
    $('http').textContent = resp.status;
    $('enc').textContent  = enc.toUpperCase();
    if (!resp.ok) throw new Error('HTTP '+resp.status);
    return text;
  }

  /* ---------- Estado ---------- */
  const Catalog = {
    sep:',',
    headersRaw:[],
    headersNorm:[],
    rows:[],
    idx:{ MOD:-1, COLOR:-1, TALLA:-1, BC:-1 },
  };

  // Alias ampliados y coincidencia flexible
  const ALIASES = {
    MOD:   ['MOD','MODELO','SKU','ESTILO','STYLE','ARTICULO','REFERENCIA','PRODUCTO','MODELO DESCRIPCION','DESC MODELO','DESC. MODELO'],
    COLOR: ['COLOR','COL','CLR','COLOR DESCRIPCION','DESC COLOR','COLOR NOMBRE','COLORNAME'],
    TALLA: ['TALLA','TALL','SIZE','MEDIDA','NUMERO','NUM','TALLA MX','SIZE MX','MEASURE'],
    BC:    ['CODIGO_BARRA','CODIGO DE BARRAS','CODIGO BARRA','BARCODE','EAN','EAN13','UPC','CODIGO','COD_BARRAS','CBARRAS']
  };

  function findIdx(headersNorm, who){
    // 1) exact
    for (const a of ALIASES[who]) {
      const p = headersNorm.indexOf(norm(a));
      if (p !== -1) return p;
    }
    // 2) contains (fuzzy)
    const patterns = {
      MOD:   [/MOD|MODELO|SKU|ESTILO|STYLE|ARTIC|REF|PROD/i],
      COLOR: [/COLOR|COL|CLR/i],
      TALLA: [/TALL|SIZE|MEDID|NUM(ERO)?/i],
      BC:    [/BAR|EAN|UPC|COD(IGO)?/i],
    };
    for (let i=0;i<headersNorm.length;i++){
      const h = headersNorm[i];
      if (patterns[who].some(rx => rx.test(h))) return i;
    }
    return -1;
  }

  function tryMapIdx(headersNorm){
    const idx = { MOD:-1, COLOR:-1, TALLA:-1, BC:-1 };
    idx.MOD   = findIdx(headersNorm,'MOD');
    idx.COLOR = findIdx(headersNorm,'COLOR');
    idx.TALLA = findIdx(headersNorm,'TALLA');
    idx.BC    = findIdx(headersNorm,'BC');
    return idx;
  }

  function fillSelect(sel, headersRaw, selectedIdx){
    sel.innerHTML = headersRaw.map((h,i)=>`<option value="${i}" ${i===selectedIdx?'selected':''}>${h}</option>`).join('');
  }

  function showMapper(headersRaw, idx){
    $('mapperCard').style.display = 'block';
    fillSelect($('selMOD'),   headersRaw, idx.MOD   === -1 ? 0 : idx.MOD);
    fillSelect($('selCOLOR'), headersRaw, idx.COLOR === -1 ? 0 : idx.COLOR);
    fillSelect($('selTALLA'), headersRaw, idx.TALLA === -1 ? 0 : idx.TALLA);
    $('mapStatus').textContent = 'Selecciona y confirma';
  }

  function hideMapper(){ $('mapperCard').style.display = 'none'; }

  /* ---------- Cargar catálogo ---------- */
  async function cargarCatalogo(){
    const url = $('path').value.trim();
    $('status').textContent = 'Descargando…';
    $('sep').textContent = $('hdrs').textContent = $('rows').textContent = '—';
    try{
      let text = await fetchDecoded(url);
      if (text.charCodeAt(0)===0xFEFF) text = text.slice(1);
      const det = detectCSV(text);
      $('sep').textContent = det.delim === '\\t' ? 'TAB' : det.delim;

      let lines = text.split(/\\r\\n|\\n|\\r/);
      if (det.dropFirst) lines = lines.slice(1);
      lines = lines.filter(l=>l.trim().length>0);
      if (!lines.length) throw new Error('Catálogo vacío');

      const d = det.delim;
      const headersRaw  = splitCSV(lines[0], d);
      const headersNorm = headersRaw.map(h=>norm(h));
      const idx = tryMapIdx(headersNorm);

      const rows=[]; for(let i=1;i<lines.length;i++){ rows.push( splitCSV(lines[i], d) ); }

      Object.assign(Catalog, { sep:d, headersRaw, headersNorm, rows, idx });

      $('hdrs').textContent = headersRaw.join(' | ');
      $('rows').textContent = rows.length;

      // Si falta alguno, pide mapeo manual
      if (idx.MOD<0 || idx.COLOR<0 || idx.TALLA<0){
        $('status').innerHTML = '<span class="err">Faltan columnas. Mapea abajo.</span>';
        showMapper(headersRaw, idx);
      } else {
        $('status').innerHTML = '<span class="ok">OK</span>';
        hideMapper();
        $('btnProcesar').disabled = false;
      }
    }catch(e){
      $('status').innerHTML = '<span class="err">❌ '+(e?.message||e)+'</span>';
      $('btnProcesar').disabled = true;
      hideMapper();
      alert('Error cargando catálogo: ' + (e?.message||e));
    }
  }

  // Confirmar mapeo manual
  $('btnConfirmMap').addEventListener('click', ()=>{
    Catalog.idx.MOD   = Number($('selMOD').value);
    Catalog.idx.COLOR = Number($('selCOLOR').value);
    Catalog.idx.TALLA = Number($('selTALLA').value);
    $('mapStatus').textContent = `Listo: MOD=${Catalog.idx.MOD}, COLOR=${Catalog.idx.COLOR}, TALLA=${Catalog.idx.TALLA}`;
    $('status').innerHTML = '<span class="ok">OK (mapeo manual)</span>';
    $('btnProcesar').disabled = false;
  });

  /* ---------- Existencias (pegar) ---------- */
  function parseExistenciasText(text){
    // Espera: MODELO, COLOR ..... TALLA ..... CANT
    const map = new Map(); // key -> cant
    const lines = (text||'').split(/\\r\\n|\\n|\\r/).map(s=>s.trim()).filter(Boolean);
    let nLineas=0, nOmitidos=0, nPiezas=0;

    for(const line of lines){
      nLineas++;
      let modelo='', resto='';
      const coma = line.indexOf(',');
      if (coma >= 0){
        modelo = line.slice(0, coma).trim();
        resto  = line.slice(coma+1).trim();
      } else { nOmitidos++; continue; }

      const m = /^(.*\\S)\\s+(\\S+)\\s+(\\d+(?:[.,]\\d+)?)$/.exec(resto);
      if(!m){
        const m2 = /^(.*\\S)\\s+(\\S+)$/.exec(resto);
        if(!m2){ nOmitidos++; continue; }
        const color = (m2[1]||'').trim();
        const talla = (m2[2]||'').trim();
        const cant  = 1;
        const k = `${norm(modelo)}|${norm(color)}|${norm(talla)}`;
        map.set(k, (map.get(k)||0) + cant);
        nPiezas += cant;
      }else{
        const color = (m[1]||'').trim();
        const talla = (m[2]||'').trim();
        const cant  = Number((m[3]||'1').replace(',','.')) || 1;
        const k = `${norm(modelo)}|${norm(color)}|${norm(talla)}`;
        map.set(k, (map.get(k)||0) + cant);
        nPiezas += cant;
      }
    }
    return { agg:map, nLineas, nOmitidos, nPiezas, nClaves: map.size };
  }

  function renderTeorico(aggMap){
    let html=''; let total=0;
    for(const [k, cant] of aggMap.entries()){
      const [mm,cc,tt] = k.split('|');
      total += cant;
      html += `<tr><td>${mm}</td><td>${cc}</td><td>${tt}</td><td style="text-align:right">${cant}</td></tr>`;
    }
    $('tbodyTeo').innerHTML = html || '<tr><td colspan="4">—</td></tr>';
    $('totTeo').textContent = total;
    return total;
  }

  function exportTeoricoCSV(aggMap){
    const rows = [['MODELO','COLOR','TALLA','CANTIDAD']];
    for(const [k,c] of aggMap.entries()){
      const [mm,cc,tt] = k.split('|');
      rows.push([mm,cc,tt,String(c)]);
    }
    const csv = rows.map(r=>r.map(v=>{
      v = v ?? '';
      if (/[",;\\t]/.test(v)) return '"'+v.replace(/"/g,'""')+'"';
      return v;
    }).join(',')).join('\\r\\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'existencias_teorico.csv';
    document.body.appendChild(a); a.click(); a.remove();
  }

  /* ---------- Eventos ---------- */
  $('btnLoad').addEventListener('click', cargarCatalogo);
  $('btnBust').addEventListener('click', ()=>{
    const u = $('path').value.trim();
    $('path').value = u + (u.includes('?')?'&':'?') + 'v=' + Date.now();
  });
  $('btnProcesar').addEventListener('click', ()=>{
    if (!Catalog.rows.length){ alert('Primero carga el Catálogo.'); return; }
    if (Catalog.idx.MOD<0 || Catalog.idx.COLOR<0 || Catalog.idx.TALLA<0){
      $('mapperCard').scrollIntoView({behavior:'smooth'}); return;
    }
    const { agg, nLineas, nOmitidos, nPiezas, nClaves } = parseExistenciasText( $('paste').value );
    $('nClaves').textContent  = nClaves;
    $('nPiezas').textContent  = nPiezas;
    $('nLineas').textContent  = nLineas;
    $('nOmitidos').textContent= nOmitidos;
    renderTeorico(agg);
    $('resumenTeo').textContent = nClaves ? `OK: ${nClaves} claves · ${nPiezas} piezas` : '—';
    $('btnExportTeorico').disabled = nClaves === 0;
    window._existTeorico = agg;
  });
  $('btnExportTeorico').addEventListener('click', ()=>{
    if (!window._existTeorico) return;
    exportTeoricoCSV(window._existTeorico);
  });
})();
</script>
</body>
</html>
