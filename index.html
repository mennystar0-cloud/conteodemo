<!-- path: /index.html (LEGACY ES5 COMPAT) -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- mantener por compatibilidad iOS antiguos -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Conteo Cíclico</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%23000000'/%3E%3Ctext x='2' y='12' fill='%23ffffff' font-family='Arial' font-size='10'%3ECC%3C/text%3E%3C/svg%3E">
  <script>
    (function(){
      try{ if('serviceWorker' in navigator && window.isSecureContext){ navigator.serviceWorker.register('./sw.js').catch(function(){}); } }catch(e){}
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="static/xlsx.full.min.js"></script>
  <script src="static/quagga.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-storage-compat.js"></script>
  <style>
    .btn{padding:.5rem .75rem;border-radius:.5rem;font-size:.875rem}
    .tab-btn{padding:.5rem .75rem;border-bottom:2px solid transparent}
    .card{background:#fff;padding:1rem;border-radius:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .cam{height:45vh;max-height:400px;background:#000;overflow:hidden;border-radius:1rem}
    th,td{padding:.35rem .5rem;border-bottom:1px solid #eee}
    .badge{border-radius:.5rem;padding:.1rem .5rem;font-size:.75rem}
    .mode-xl body{background:#0b0b0b;color:#fff;}
    .mode-xl .card{background:#111827;color:#fff;}
    .mode-xl .btn{padding:0.9rem 1.1rem;font-size:1.125rem;border-width:2px;}
    .mode-xl .tab-btn{padding:.75rem 1rem;font-weight:600;}
    .mode-xl input,.mode-xl select,.mode-xl textarea{font-size:1.05rem;}
    .mode-xl .cam{height:60vh;max-height:none;}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-7xl mx-auto p-4">
  <header class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-xl font-bold">Conteo Cíclico — Catálogo + Existencias + Escaneo</h1>
      <p class="text-sm text-gray-600">Configuración en PC, escaneo en móviles por folio (PWA).</p>
    </div>
    <div class="text-sm text-gray-600">
      <span id="envInfo" class="badge bg-gray-100">Sin folio</span>
      <button id="btnInstall" class="btn bg-emerald-600 text-white hidden ml-2">Instalar app</button>
    </div>
  </header>

  <nav class="flex flex-wrap gap-2 mb-4" id="tabs">
    <button data-tab="importar" class="tab-btn border-blue-600 text-blue-600">Importar</button>
    <button data-tab="existencias" class="tab-btn">Existencias</button>
    <button data-tab="folio" class="tab-btn">Folio</button>
    <button data-tab="escanear" class="tab-btn">Escanear</button>
    <button data-tab="reporte" class="tab-btn">Reporte</button>
    <button data-tab="consulta" class="tab-btn">Consulta</button>
    <button data-tab="historial" class="tab-btn">Historial</button>
  </nav>

  <section id="tab-importar" class="block">
    <div class="card">
      <h2 class="font-semibold mb-2">Catálogo maestro (Local/PWA)</h2>
      <p class="text-sm text-gray-600">Lee <code>static/catalogo-master.xlsx</code> local (sin CORS). Columnas: <code>CODIGO_BARRA</code>, <code>MOD</code>, <code>COLOR</code>, <code>TALLA</code>.</p>
      <div class="flex flex-wrap gap-2 mt-2 items-center">
        <button id="btnRecargarCloud" class="btn bg-blue-600 text-white">Recargar catálogo</button>
        <button id="btnForzarURL" class="btn bg-amber-500 text-white">Forzar URL única</button>
        <button id="btnPlantillaCSV" class="btn bg-gray-200">Descargar plantilla CSV</button>
        <span id="importStatus" class="text-sm text-gray-700">—</span>
      </div>
    </div>
  </section>

  <section id="tab-existencias" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Pegar existencias (teórico)</h2>
      <p class="text-sm text-gray-600">Formato: <code>MODELO,COLOR TALLA CANTIDAD</code> o CSV <code>MODELO,COLOR,TALLA,CANTIDAD</code>.</p>
      <textarea id="existText" rows="8" class="w-full border rounded p-2" placeholder="Ejemplos&#10;587-12,NEGRO 250 3&#10;040-83,ANIMAL PRINT 230 3&#10;ABC-01,ROJO,27,2"></textarea>
      <div class="flex flex-wrap gap-2 mt-2 items-center">
        <button id="btnValidarExist" class="btn bg-gray-200">Validar</button>
        <button id="btnCargarExist" class="btn bg-green-600 text-white">Cargar al folio</button>
        <button id="btnLimpiarExist" class="btn bg-gray-200">Limpiar</button>
        <span id="existStatus" class="text-sm text-gray-700">—</span>
      </div>
      <div id="existPreview" class="mt-3 text-sm"></div>
    </div>
  </section>

  <section id="tab-folio" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Folio</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <input id="folioName" class="border p-2 rounded w-full" placeholder="Nombre del folio">
          <div class="grid grid-cols-2 gap-2">
            <input id="operador" class="border p-2 rounded" placeholder="¿Quién realiza el cíclico?">
            <select id="almacen" class="border p-2 rounded w-full">
              <option value="" disabled selected>Tipo de almacén…</option>
              <option value="Sucursal">Sucursal</option>
              <option value="CEDIS">CEDIS</option>
              <option value="Bodega">Bodega</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <select id="temporada" class="border p-2 rounded w-full">
            <option value="TODAS">Temporada: TODAS</option>
            <option value="LINEA">LÍNEA</option>
            <option value="OFERTA">OFERTA</option>
            <option value="SALDO">SALDO</option>
            <option value="PASO">PASO</option>
          </select>
          <div class="mt-2 flex gap-2">
            <button id="btnCrearFolio" class="btn bg-green-600 text-white">Crear folio</button>
            <button id="btnCerrarFolio" class="btn bg-gray-200" title="Cierra el folio actual">Cerrar folio</button>
          </div>
        </div>
        <div class="space-y-2">
          <input id="joinFolioId" class="border p-2 rounded w-full" placeholder="ID existente (000001)">
          <div class="flex gap-2">
            <button id="btnUnirseFolio" class="btn bg-blue-600 text-white">Unirse</button>
            <button id="btnCopiarLink" class="btn bg-gray-200">Copiar link</button>
          </div>
          <div class="text-xs text-gray-600">Fecha creación: <span id="folioFecha">—</span></div>
        </div>
      </div>
      <div id="folioStatus" class="text-sm text-gray-600 mt-2">—</div>
    </div>
  </section>

  <section id="tab-escanear" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Escanear</h2>
      <div class="flex flex-wrap items-center gap-3 mb-3 text-sm">
        <label class="flex items-center gap-2"><input id="toggleXL" type="checkbox" class="h-4 w-4">Modo tienda (alto contraste / XL)</label>
        <label class="flex items-center gap-2"><input id="toggleSave" type="checkbox" class="h-4 w-4">Ahorro de batería (menos FPS)</label>
        <label class="flex items-center gap-2"><input id="toggleMute" type="checkbox" class="h-4 w-4">Silencio (sin beep/vibración)</label>
        <label class="flex items-center gap-2">Cooldown
          <input id="cooldownMs" type="number" min="0" step="100" value="800" class="border p-1 rounded w-24"> ms
        </label>
        <span id="fpsBadge" class="badge bg-gray-100">FPS: --</span>
        <span class="text-xs text-gray-500">Se guarda en este dispositivo</span>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="cam"><div id="interactive" class="viewport w-full h-full"></div></div>
          <div class="flex gap-2 mt-2 items-center">
            <select id="cameraSelect" class="border p-1"></select>
            <button id="btnRefreshCam" class="btn bg-gray-200">Refrescar cámaras</button>
            <button id="btnTorch" class="btn bg-gray-200">Linterna</button>
            <button id="btnStart" class="btn bg-blue-600 text-white">Iniciar</button>
            <button id="btnStop" class="btn bg-gray-200">Detener</button>
            <button id="btnDiag" class="btn bg-gray-200">Diagnóstico</button>
          </div>
        </div>
        <div>
          <div class="grid grid-cols-2 gap-2">
            <input id="scanArea" class="border p-2 rounded" placeholder="Área (persistente)">
            <input id="scanPos"  class="border p-2 rounded" placeholder="Posición (persistente)">
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <input id="scanOperador" class="border p-2 rounded" placeholder="Operador (persistente)">
          </div>
          <label class="text-sm mt-2 block">Entrada manual</label>
          <input id="manualCode" class="border p-2 rounded w-full" placeholder="Pega un código y Enter">
          <div id="lastItem" class="mt-2 text-sm text-gray-700">—</div>
        </div>
      </div>
    </div>
  </section>

  <div id="diagModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-4 max-w-xl w-[90%]">
      <h3 class="font-semibold mb-2">Diagnóstico de cámara / entorno</h3>
      <div id="diagContent" class="text-sm whitespace-pre-wrap">Cargando…</div>
      <div class="mt-3 text-right">
        <button id="btnDiagClose" class="btn bg-gray-200">Cerrar</button>
      </div>
    </div>
  </div>

  <section id="tab-reporte" class="hidden">
    <div class="card">
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <h2 class="font-semibold">Reporte</h2>
        <select id="groupMode" class="ml-auto border p-1 rounded text-sm">
          <option value="general">General</option>
          <option value="area">Agrupar por área</option>
        </select>
        <input id="filtroModelo" class="border p-1 rounded text-sm" placeholder="Filtrar modelo">
        <input id="filtroColor" class="border p-1 rounded text-sm" placeholder="Filtrar color">
        <input id="filtroTalla" class="border p-1 rounded text-sm" placeholder="Filtrar talla">
        <button id="btnRefrescarReporte" class="btn bg-blue-600 text-white">Refrescar</button>
        <button id="btnExportarCSV" class="btn bg-gray-200">Exportar CSV</button>
        <button id="btnBorrarArea" class="btn bg-red-600 text-white" title="Elimina scans por área (máx 1000)">Borrar por área</button>
      </div>
      <div class="overflow-auto max-h-[60vh]">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr>
              <th class="text-left">Área</th>
              <th class="text-left">Modelo</th>
              <th class="text-left">Color</th>
              <th class="text-left">Talla</th>
              <th class="text-right">Teórico</th>
              <th class="text-right">Escaneado</th>
              <th class="text-right">Diferencia</th>
            </tr>
          </thead>
          <tbody id="reportBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="tab-consulta" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Consulta de modelo / color / talla</h2>
      <div class="grid md:grid-cols-4 gap-2">
        <input id="qModelo" class="border p-2 rounded" placeholder="Modelo">
        <input id="qColor"  class="border p-2 rounded" placeholder="Color">
        <input id="qTalla"  class="border p-2 rounded" placeholder="Talla">
        <button id="btnBuscarModelo" class="btn bg-blue-600 text-white">Buscar</button>
      </div>
      <div class="overflow-auto max-h-[60vh] mt-3">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr>
              <th class="text-left">Fecha</th>
              <th class="text-left">Área</th>
              <th class="text-left">Posición</th>
              <th class="text-left">Operador</th>
              <th class="text-left">Temporada</th>
            </tr>
          </thead>
          <tbody id="consultaBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="tab-historial" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Historial</h2>
      <div class="overflow-auto max-h-[60vh]">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr>
              <th class="text-left">Fecha</th>
              <th class="text-left">Área</th>
              <th class="text-left">Posición</th>
              <th class="text-left">Código</th>
              <th class="text-left">Modelo</th>
              <th class="text-left">Color</th>
              <th class="text-left">Talla</th>
              <th class="text-left">Operador</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  // ===== Firebase =====
  var firebaseConfig={ apiKey:"AIzaSyBe23iKn2bl0YMxsXUiTN5SkUrD9Vhvfo", authDomain:"cklass-conteo-ec4f5.firebaseapp.com", projectId:"cklass-conteo-ec4f5", storageBucket:"cklass-conteo-ec4f5.appspot.com", appId:"1:148726861241:web:592f683e941d13d2829e68" };
  if(!firebase.apps || firebase.apps.length===0) firebase.initializeApp(firebaseConfig);
  var db=firebase.firestore(); var storage=firebase.storage(); db.enablePersistence().catch(function(){});

  // ===== Helpers =====
  function $(id){ return document.getElementById(id); }
  function on(id, ev, fn){ var n=$(id); if(n) n.addEventListener(ev, fn); }
  function markInvalid(el,msg){ if(!el) return; el.classList.add('ring-2','ring-red-500','border-red-500'); if(msg) el.setAttribute('title',msg); try{ el.focus(); }catch(e){} }
  function clearInvalid(el){ if(!el) return; el.classList.remove('ring-2','ring-red-500','border-red-500'); el.removeAttribute('title'); }
  function esc(s){ return String(s).replace(/[&<>]/g,function(m){ return {"&":"&amp;","<":"&lt;",">":"&gt;"}[m];}); }
  function fmt(d){ function p(n){return String(n).padStart(2,'0');} return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate())+" "+p(d.getHours())+":"+p(d.getMinutes()); }
  function canon(s){ s=(s||'').toString(); if(s.normalize){ s=s.normalize('NFD').replace(/[̀-ͯ]/g,''); } return s.trim().toUpperCase(); }
  function keyOf(mod,color,talla){ return (mod||'').trim()+"|"+(color||'').trim()+"|"+(talla||'').trim(); }
  function splitKey(k){ var a=String(k||'').split('|'); return {mod:a[0]||'', color:a[1]||'', talla:a[2]||''}; }

  // ===== Tabs =====
  function showTab(name){ var names=['importar','existencias','folio','escanear','reporte','consulta','historial']; for(var i=0;i<names.length;i++){ var t=names[i]; var el=$("tab-"+t); if(!el) continue; el.classList.toggle('hidden', t!==name); el.classList.toggle('block', t===name); } }
  window.addEventListener('DOMContentLoaded', function(){
    var tabs=document.querySelectorAll('#tabs [data-tab]');
    for(var i=0;i<tabs.length;i++)(function(btn){ btn.addEventListener('click', function(){ for(var j=0;j<tabs.length;j++){ tabs[j].classList.remove('border-blue-600'); tabs[j].classList.remove('text-blue-600'); } btn.classList.add('border-blue-600'); btn.classList.add('text-blue-600'); showTab(btn.getAttribute('data-tab')); }); })(tabs[i]);
    var isStandalone=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||window.navigator.standalone; if(isStandalone||window.innerWidth<768){ showTab('escanear'); }else{ showTab('importar'); }
    var ids=['operador','almacen','temporada','scanArea','scanPos','scanOperador'];
    for(var k=0;k<ids.length;k++){ var el=$(ids[k]); if(!el) continue; var v=localStorage.getItem('cc-'+ids[k]); if(v!==null) el.value=v; el.addEventListener('input',function(e){ clearInvalid(e.target); localStorage.setItem('cc-'+e.target.id, e.target.value); }); el.addEventListener('change',function(e){ clearInvalid(e.target); localStorage.setItem('cc-'+e.target.id, e.target.value); }); }
    var xlPref=localStorage.getItem('cc-mode-xl'); var autoXL=(isStandalone||window.innerWidth<768); var xlOn=(xlPref!==null)?(xlPref==='1'):autoXL; document.documentElement.classList.toggle('mode-xl', !!xlOn); if($('toggleXL')) $('toggleXL').checked=!!xlOn; localStorage.setItem('cc-mode-xl', xlOn?'1':'0');
    var savePref=localStorage.getItem('cc-battery-save'); var saveOn=(savePref!==null)?(savePref==='1'):(window.innerWidth<768); setBatterySave(!!saveOn); if($('toggleSave')) $('toggleSave').checked=!!saveOn;
    var mutePref=localStorage.getItem('cc-mute'); var muteOn=(mutePref!==null)?(mutePref==='1'):document.documentElement.classList.contains('mode-xl'); MUTE=!!muteOn; if($('toggleMute')) $('toggleMute').checked=!!muteOn;
    var cdPref=localStorage.getItem('cc-cooldown'); COOLDOWN_MS=isNaN(parseInt(cdPref||'',10))?800:parseInt(cdPref,10); if($('cooldownMs')) $('cooldownMs').value=COOLDOWN_MS;
    var folioParam=(new URL(location.href)).searchParams.get('folio'); if(folioParam) $('joinFolioId').value=folioParam;
    // Prefill: si operador vacío, usa último guardado
    if($('operador') && !$('operador').value.trim()){
      var lastOp = localStorage.getItem('cc-operador') || localStorage.getItem('cc-scanOperador') || '';
      if(lastOp) $('operador').value = lastOp;
    }
    cargarCatalogo(false);
  });

  // ===== XLSX fallback =====
  function loadScript(url){ return new Promise(function(res,rej){ var s=document.createElement('script'); s.src=url; s.onload=res; s.onerror=function(){rej(new Error('No se pudo cargar: '+url));}; document.head.appendChild(s); }); }
  function ensureXLSX(){ if(window.XLSX) return Promise.resolve(); var cdns=['https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js','https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js','https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js']; var i=0; function next(){ if(window.XLSX) return Promise.resolve(); if(i>=cdns.length) return Promise.reject(new Error('XLSX no disponible')); return loadScript(cdns[i++]).then(function(){ if(!window.XLSX) return next(); }); } return next(); }

  // ===== Catálogo =====
  var CATALOGO={ byBarcode:{}, byVariant:{} };
  function mapSet(m,k,v){ m[k]=v; }
  function mapGet(m,k){ return m[k]; }
  function mapHas(m,k){ return Object.prototype.hasOwnProperty.call(m,k); }
  function mapClear(m){ for(var x in m) if(Object.prototype.hasOwnProperty.call(m,x)) delete m[x]; }
  function mapForEach(m,fn){ for(var x in m) if(Object.prototype.hasOwnProperty.call(m,x)) fn(m[x],x); }

  function buildCatalog(rows){ var res={ byBarcode:{}, byVariant:{} }; var H=(rows[0]||[]); for(var h=0;h<H.length;h++) H[h]=canon(H[h]); function idx(names){ for(var j=0;j<names.length;j++){ var ii=H.indexOf(canon(names[j])); if(ii>=0) return ii; } return -1; }
    var iCode=idx(['CODIGO_BARRA','CODIGO','EAN','UPC']); var iMod=idx(['MOD','MODELO','SKU']); var iColor=idx(['COLOR']); var iTalla=idx(['TALLA']);
    for(var r=1;r<rows.length;r++){ var row=rows[r]||[]; var code=String(row[iCode]||'').trim(); var mod=String(row[iMod]||'').trim(); var color=String(row[iColor]||'').trim(); var talla=String(row[iTalla]||'').trim(); if(!code||!mod) continue; var vkey=keyOf(mod,color,talla); var item={mod:mod,color:color,talla:talla,vkey:vkey}; mapSet(res.byBarcode, code, item); if(!mapHas(res.byVariant, vkey)) mapSet(res.byVariant, vkey, item); }
    return res; }
  function cargarCatalogo(force){ $('importStatus').textContent='Descargando...'; var url='static/catalogo-master.xlsx'+(force?('?v='+Date.now()):''); fetch(url,{cache:'no-store'}).then(function(resp){ if(!resp.ok) throw new Error('HTTP '+resp.status); return resp.arrayBuffer(); }).then(function(ab){ return ensureXLSX().then(function(){return ab;}); }).then(function(ab){ var wb=XLSX.read(ab,{type:'array'}); var sh=wb.Sheets[wb.SheetNames[0]]; var rows=XLSX.utils.sheet_to_json(sh,{header:1,defval:''}); CATALOGO=buildCatalog(rows); $('importStatus').textContent='Catálogo OK: '+(rows.length-1)+' filas (hoja: '+wb.SheetNames[0]+') · Origen: local'; }).catch(function(e){ console.error(e); $('importStatus').textContent='Error: '+(e.message||e); }); }
  on('btnRecargarCloud','click', function(){ cargarCatalogo(false); });
  on('btnForzarURL','click', function(){ cargarCatalogo(true); });
  on('btnPlantillaCSV','click', function(){ var csv='MODELO,COLOR,TALLA,CANTIDAD\n587-12,NEGRO,250,3\n'; var blob=new Blob([csv],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plantilla_existencias.csv'; a.click(); URL.revokeObjectURL(a.href); });

  // ===== Folio =====
  var FOLIO_ID=null, FOLIO_DOC=null; var COUNTS={}; var AGG_BY_AREA={};
  function nextFolioNumber(){ var ref=db.collection('meta').doc('counters'); return db.runTransaction(function(tx){ return tx.get(ref).then(function(snap){ var cur=snap.exists?(snap.data().nextFolio||1):1; tx.set(ref,{nextFolio:cur+1},{merge:true}); return cur; }); }); }
  function req(input,msg){
    var el = (input && input.nodeType===1)? input : (input && input.value!==undefined ? input : null);
    var val = el? el.value : (typeof input==='string'? input : (input && typeof input==='object' && 'value' in input ? input.value : input));
    var s = String(val||'').trim();
    if(!s){ if(el) markInvalid(el,msg); alert(msg); throw new Error(msg); }
    if(el) clearInvalid(el);
    return s; }
  function activarFolio(id){ return db.collection('folios').doc(id).get().then(function(snap){ if(!snap.exists){ alert('Folio no encontrado'); return; } FOLIO_ID=id; FOLIO_DOC=snap.data(); $('envInfo').textContent='Folio '+id; $('joinFolioId').value=id; var dt=(FOLIO_DOC && FOLIO_DOC.createdAt && typeof FOLIO_DOC.createdAt.toDate==='function')? FOLIO_DOC.createdAt.toDate():new Date(); $('folioFecha').textContent=fmt(dt); $('folioStatus').innerHTML='Folio: <b>'+id+'</b> — '+esc(FOLIO_DOC.name||'')+' · Operador: '+esc(FOLIO_DOC.createdBy||'')+' · Almacén: '+esc(FOLIO_DOC.almacen||'')+' · Temporada: '+esc(FOLIO_DOC.temporada||''); document.title='Folio '+id+' · Conteo Cíclico'; subscribeCounts(); subscribeScans(); }); }
  function crearFolio(){
    try{
      var name=($('#folioName')&&$('#folioName').value||'Cíclico'); name=(name||'').trim()||'Cíclico';
      var opEl = $('#operador');
      if(opEl && !opEl.value.trim()){
        var last = localStorage.getItem('cc-operador') || localStorage.getItem('cc-scanOperador') || '';
        if(last) opEl.value = last;
      }
      var operador=req(opEl,'Indica quién realiza el cíclico');
      // Persistimos el operador usado
      localStorage.setItem('cc-operador', operador);
      var almacen=(($('#almacen')&&$('#almacen').value)||'').trim()||'Sucursal';
      var temporada=($('#temporada')&&$('#temporada').value)||'TODAS';
      return nextFolioNumber().then(function(number){
        var id=String(number).padStart(6,'0'); var ref=db.collection('folios').doc(id);
        return ref.set({ id:id, number:number, name:name, createdBy:operador, almacen:almacen, temporada:temporada, state:'open', existenciasMap:{}, createdAt: firebase.firestore.FieldValue.serverTimestamp() }).then(function(){ return activarFolio(id); });
      }).catch(function(e){ console.warn(e && e.message ? e.message : e); });
    }catch(e){ console.warn(e && e.message ? e.message : e); return Promise.resolve(); }
  }, createdAt: firebase.firestore.FieldValue.serverTimestamp() }).then(function(){ return activarFolio(id); }); }).catch(function(e){ console.warn(e && e.message ? e.message : e); }); }catch(e){ console.warn(e && e.message ? e.message : e); return Promise.resolve(); } }
  function unirseFolio(){ var id=($('#joinFolioId')&&$('#joinFolioId').value||'').trim(); if(!id) return; return activarFolio(id); }
  on('btnCrearFolio','click', crearFolio);
  on('btnUnirseFolio','click', unirseFolio);
  on('btnCopiarLink','click', function(){ if(!FOLIO_ID) return; var u=new URL(location.href); u.searchParams.set('folio',FOLIO_ID); navigator.clipboard.writeText(u.toString()); alert('Link copiado'); });
  on('btnCerrarFolio','click', function(){ if(!FOLIO_ID) return; db.collection('folios').doc(FOLIO_ID).update({state:'closed'}).then(function(){ alert('Folio cerrado'); }); });

  // ===== Existencias =====
  on('btnLimpiarExist','click', function(){ $('existText').value=''; $('existStatus').textContent='—'; $('existPreview').innerHTML=''; });
  on('btnValidarExist','click', function(){ renderExistPreview(parseExistencias($('existText').value||'')); });
  on('btnCargarExist','click', function(){ try{ if(!FOLIO_ID) return alert('Crea/Activa un folio'); var res=parseExistencias($('existText').value||''); var map=res.map; if(Object.keys(map).length===0) return alert('No hay líneas válidas'); db.collection('folios').doc(FOLIO_ID).set({ existenciasMap: map, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },{merge:true}).then(function(){ $('existStatus').textContent='Cargadas '+Object.keys(map).length+' variantes (pzs: '+res.total+')'; }).catch(function(e){ console.error(e); $('existStatus').textContent='Error: '+(e.message||e); }); }catch(e){ console.error(e); $('existStatus').textContent='Error: '+(e.message||e); } });
  function parseExistencias(text){ var out={}, bad=[]; var lines=(text||'').split(/\r?\n/); var i,ln; for(i=0;i<lines.length;i++){ ln=(lines[i]||'').trim(); if(!ln) continue; var parts=ln.split(','); if(parts.length===4){ var mod=parts[0].trim(); var color=parts[1].trim(); var talla=parts[2].trim(); var qty=parseInt(String(parts[3]).trim(),10); if(mod && color && talla && !isNaN(qty)){ var k=keyOf(mod,color,talla); out[k]=(out[k]||0)+qty; continue; } }
    if(ln.indexOf(',')>=0){ var first=ln.indexOf(','); var mod2=ln.slice(0,first).trim(); var rest=ln.slice(first+1).trim(); var mQty=rest.match(/(\d+)\s*$/); if(mQty){ var qty2=parseInt(mQty[1],10); var rest2=rest.slice(0,mQty.index).trim(); var mTalla=rest2.match(/([A-Za-z0-9_.\-]+)\s*$/); if(mTalla){ var talla2=mTalla[1]; var color2=rest2.slice(0,rest2.length-mTalla[0].length).trim(); if(mod2 && color2 && talla2 && !isNaN(qty2)){ var k2=keyOf(mod2,color2,talla2); out[k2]=(out[k2]||0)+qty2; continue; } } } }
    bad.push({line:i+1, text:ln}); }
    var total=0; for(var k in out){ if(Object.prototype.hasOwnProperty.call(out,k)) total+=out[k]; }
    return {map:out, bad:bad, total:total}; }
  function renderExistPreview(res){ var rows=""; var count=0; for(var k in res.map){ if(!Object.prototype.hasOwnProperty.call(res.map,k)) continue; if(count>=600) break; var qty=res.map[k]; var o=splitKey(k); rows += '<tr><td>'+esc(o.mod)+'</td><td>'+esc(o.color)+'</td><td>'+esc(o.talla)+'</td><td class="text-right">'+qty+'</td></tr>'; count++; }
    var bads=""; for(var i=0;i<res.bad.length;i++){ bads += '<li>L'+res.bad[i].line+': '+esc(res.bad[i].text)+'</li>'; }
    $('existPreview').innerHTML = "<div class='mt-2'>"+
      "<div class='text-sm'>Variantes válidas: <b>"+Object.keys(res.map).length+"</b> · Pzs: <b>"+res.total+"</b> "+(res.bad.length?"· Inválidas: <b class='text-red-600'>"+res.bad.length+"</b>":"")+"</div>"+
      "<div class='grid md:grid-cols-2 gap-4 mt-2'>"+
        "<div class='overflow-auto max-h-[40vh]'>"+
          "<table class='w-full text-sm'><thead><tr><th>Modelo</th><th>Color</th><th>Talla</th><th class='text-right'>Cant</th></tr></thead><tbody>"+rows+"</tbody></table>"+
        "</div>"+
        "<div>"+
          (res.bad.length?"<h3 class='font-semibold mb-1'>Líneas inválidas</h3><ul class='list-disc pl-5 text-red-600 text-sm'>"+bads+"</ul>":"<div class='text-sm text-emerald-700'>Sin errores</div>")+
        "</div>"+
      "</div>"+
    "</div>"; }

  // ===== GS1/EAN =====
  function computeEAN13CheckDigit(d12){ var a=d12.split(''); var s=0; for(var i=0;i<12;i++) s+=parseInt(a[i],10)*(i%2?3:1); return String((10-(s%10))%10); }
  function toEAN13FromGTIN14(gt){ if(!/^\d{14}$/.test(gt)) return null; var b=gt.slice(1,13); return b+computeEAN13CheckDigit(b); }
  function normalizeBarcode(raw){ var s=String(raw).trim(); if(/^\d{13}$/.test(s)){ var cd=computeEAN13CheckDigit(s.slice(0,12)); return {ean13:s.slice(0,12)+cd}; } if(/^\d{12}$/.test(s)) return {ean13:'0'+s}; if(/^\d{14}$/.test(s)) return {ean13:toEAN13FromGTIN14(s)}; return {raw:s}; }

  // ===== Haptic/Beep + FPS =====
  var MUTE=false, COOLDOWN_MS=800; var LAST_SEEN={};
  var audioCtx=null; function ensureAudio(){ try{ if(!audioCtx){ var AC=window.AudioContext||window.webkitAudioContext; if(AC) audioCtx=new AC(); } }catch(e){} }
  function beep(freq,ms){ if(MUTE||!audioCtx) return; try{ var o=audioCtx.createOscillator(); var g=audioCtx.createGain(); o.frequency.value=freq; g.gain.value=0.045; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(function(){ try{o.stop();}catch(_){} }, ms||80); }catch(_){} }
  function haptic(pattern){ if(MUTE) return; try{ if(navigator.vibrate) navigator.vibrate(pattern||25); }catch(_){ } }
  var fpsTicker={on:false}; var fpsRaf=0,fpsCnt=0,fpsLast=0; function startFpsMonitor(){ if(fpsTicker.on) return; fpsTicker.on=true; fpsCnt=0; fpsLast=performance.now(); function step(t){ if(!fpsTicker.on) return; fpsCnt++; if(t-fpsLast>=1000){ var el=$('fpsBadge'); if(el) el.textContent='FPS: '+fpsCnt; fpsCnt=0; fpsLast=t; } fpsRaf=requestAnimationFrame(step); } fpsRaf=requestAnimationFrame(step);} function stopFpsMonitor(){ if(fpsRaf) cancelAnimationFrame(fpsRaf); fpsTicker.on=false; var el=$('fpsBadge'); if(el) el.textContent='FPS: --'; }

  // ===== Escáner =====
  var scanning=false, activeTrack=null, TORCH=false, lastDetect=0; var BATTERY_SAVE=false, PROC_INTERVAL_MS=80, lastProc=0; function setBatterySave(on){ BATTERY_SAVE=!!on; PROC_INTERVAL_MS= BATTERY_SAVE?280:80; localStorage.setItem('cc-battery-save', BATTERY_SAVE?'1':'0'); }
  var bdDetector=null, rafId=0, videoEl=null, canvasEl=null, ctx=null; function hasBarcodeDetector(){ return ('BarcodeDetector' in window); }
  function getVideoConstraints(devId){ var base={ facingMode:{ ideal:'environment' }, width:{ ideal:1280 }, height:{ ideal:720 }, frameRate: BATTERY_SAVE? {ideal:15,max:15}:{ideal:30,max:30} }; return devId? { deviceId:{exact:devId}, width:base.width, height:base.height, frameRate:base.frameRate } : base; }
  function setupVideo(devId){ var constraints={ video: getVideoConstraints(devId) }; return navigator.mediaDevices.getUserMedia(constraints).then(function(stream){ var container=document.getElementById('interactive'); container.innerHTML=''; var v=document.createElement('video'); v.autoplay=true; v.playsInline=true; v.muted=true; v.style.width='100%'; v.style.height='100%'; v.srcObject=stream; container.appendChild(v); activeTrack=stream.getVideoTracks()[0]; videoEl=v; canvasEl=document.createElement('canvas'); ctx=canvasEl.getContext('2d'); return new Promise(function(res){ v.onloadedmetadata=function(){ v.play(); res(v); }; }); }); }
  function startLoopDetect(){ function loop(){ if(!scanning) return; if(videoEl && videoEl.readyState>=2){ var now=Date.now(); if(now-lastProc>=PROC_INTERVAL_MS){ lastProc=now; var w=Math.min(640, videoEl.videoWidth||640), h=Math.min(480, videoEl.videoHeight||480); canvasEl.width=w; canvasEl.height=h; ctx.drawImage(videoEl,0,0,w,h); bdDetector.detect(canvasEl).then(function(codes){ if(!codes||!codes.length) return; if(now-lastDetect<400) return; lastDetect=now; var code=(codes[0].rawValue||'').trim(); if(code) handleBarcode(code); }).catch(function(){}); } } rafId=requestAnimationFrame(loop); } loop(); }
  function startNativeDetector(){ var devId=($('cameraSelect')&&$('cameraSelect').value)||undefined; return setupVideo(devId).then(function(){ if(!bdDetector){ try{ bdDetector=new BarcodeDetector({formats:['ean_13','ean_8','upc_e','upc_a','code_128']}); }catch(e){ return Promise.reject(e); } } }).then(function(){ scanning=true; startFpsMonitor(); startLoopDetect(); }).catch(function(e){ console.warn('BarcodeDetector falló, usando Quagga', e); return startQuagga(); }); }
  function startQuagga(){ return new Promise(function(resolve){ if(!window.Quagga){ alert('Quagga no disponible'); resolve(); return; } var devId=($('cameraSelect')&&$('cameraSelect').value)||undefined; Quagga.init({ inputStream:{ name:'Live', type:'LiveStream', target: document.querySelector('#interactive'), constraints: devId? {deviceId:devId}:{ facingMode:'environment'} }, decoder:{ readers:['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader'] }, locate:true }, function(err){ if(err){ console.error(err); alert('No se pudo iniciar cámara'); resolve(); return; } scanning=true; Quagga.start(); startFpsMonitor(); setTimeout(function(){ try{ var v=document.querySelector('#interactive video'); activeTrack=v && v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks()[0]:null; }catch(e){} },300); Quagga.onDetected(function(res){ var now=Date.now(); if(now-lastDetect<400) return; lastDetect=now; var code=(res && res.codeResult && res.codeResult.code || '').trim(); if(code) handleBarcode(code); }); resolve(); }); }); }
  on('btnRefreshCam','click', function(){ navigator.mediaDevices.enumerateDevices().then(function(list){ var cams=[]; for(var i=0;i<list.length;i++){ if(list[i].kind==='videoinput') cams.push(list[i]); } var html=''; for(var j=0;j<cams.length;j++){ var d=cams[j]; html += '<option value="'+d.deviceId+'">'+(d.label||('Cam '+(d.deviceId||'').slice(-4)))+'</option>'; } $('cameraSelect').innerHTML=html; }); });
  on('btnStart','click', function(){ if(scanning) return; ensureAudio(); (hasBarcodeDetector()? startNativeDetector(): startQuagga()).catch(function(e){ console.error(e); alert('Permite el acceso a la cámara.'); }); });
  function stopScanner(){ try{ if(rafId) cancelAnimationFrame(rafId); stopFpsMonitor(); if(videoEl && videoEl.srcObject){ var tracks=videoEl.srcObject.getTracks(); for(var i=0;i<tracks.length;i++) tracks[i].stop(); } if(window.Quagga){ try{ Quagga.stop(); }catch(e){} } }catch(e){} scanning=false; activeTrack=null; TORCH=false; }
  on('btnStop','click', stopScanner);
  on('btnTorch','click', function(){ try{ if(!activeTrack){ var v=document.querySelector('#interactive video'); if(v && v.srcObject && v.srcObject.getVideoTracks){ var t=v.srcObject.getVideoTracks(); activeTrack=(t && t[0])? t[0]:null; } } if(!activeTrack) return alert('Inicia la cámara'); var caps=activeTrack.getCapabilities && activeTrack.getCapabilities(); if(!caps || !caps.torch) return alert('Linterna no soportada'); TORCH=!TORCH; activeTrack.applyConstraints({advanced:[{torch: TORCH}]}); }catch(e){ alert('Linterna no soportada'); }});
  on('toggleXL','change', function(e){ var on=e.target.checked; document.documentElement.classList.toggle('mode-xl', on); localStorage.setItem('cc-mode-xl', on?'1':'0'); });
  on('toggleSave','change', function(e){ var on=e.target.checked; var was=scanning; setBatterySave(on); if(was){ stopScanner(); (hasBarcodeDetector()? startNativeDetector(): startQuagga()); } });
  on('toggleMute','change', function(e){ MUTE=!!e.target.checked; localStorage.setItem('cc-mute', MUTE?'1':'0'); });
  on('cooldownMs','change', function(e){ var v=parseInt(e.target.value,10); if(isNaN(v)||v<0) v=0; COOLDOWN_MS=v; localStorage.setItem('cc-cooldown', String(v)); });
  document.addEventListener('visibilitychange', function(){ if(document.hidden && scanning){ stopScanner(); } });
  on('manualCode','keydown', function(e){ if(e.key==='Enter'){ var v=e.target.value.trim(); if(v) handleBarcode(v); e.target.value=''; }});

  // ===== Registro scan =====
  function registrarScan(item, code, meta){ if(!FOLIO_ID) return Promise.reject(new Error('No folio')); var refFol=db.collection('folios').doc(FOLIO_ID); var vkey=item.vkey||keyOf(item.mod,item.color,item.talla); var scanDoc={ ts: firebase.firestore.FieldValue.serverTimestamp(), code:String(code), vkey:vkey, mod:item.mod, color:item.color||'', talla:item.talla||'', area:meta.area||'', pos:meta.pos||'', user:meta.user||meta.operador||'', temporada:meta.temporada||'' }; return refFol.collection('scans').add(scanDoc).then(function(){ return refFol.collection('counts').doc(vkey).set({qty: firebase.firestore.FieldValue.increment(1)},{merge:true}); }); }
  function handleBarcode(code){ if(!FOLIO_ID){ beep(220,120); haptic([60]); return alert('Sin folio'); } if((CATALOGO.byBarcode instanceof Map && CATALOGO.byBarcode.size===0) || (!(CATALOGO.byBarcode instanceof Map) && Object.keys(CATALOGO.byBarcode).length===0)){ beep(220,120); haptic([60]); return alert('Catálogo no cargado'); } var n=normalizeBarcode(code); var key=n.ean13||code; var item=(CATALOGO.byBarcode instanceof Map)? CATALOGO.byBarcode.get(key) || CATALOGO.byBarcode.get(String(code)) : (CATALOGO.byBarcode[key] || CATALOGO.byBarcode[String(code)]);
    if(!item){ $('lastItem').textContent='No encontrado: '+code; beep(220,140); haptic([40,60,40]); return; }
    var area=(($('scanArea')&&$('scanArea').value)||'').trim(); var pos=(($('scanPos')&&$('scanPos').value)||'').trim(); var user=(($('scanOperador')&&$('scanOperador').value)||($('operador')&&$('operador').value)||(FOLIO_DOC&&FOLIO_DOC.createdBy)||'').trim(); var temporada=(FOLIO_DOC && FOLIO_DOC.temporada)?FOLIO_DOC.temporada:'TODAS'; var vkey=item.vkey||keyOf(item.mod,item.color,item.talla); var now=Date.now(); var last=(LAST_SEEN[vkey]||0); if(now-last<COOLDOWN_MS){ $('lastItem').innerHTML = "<span class='text-xs text-gray-500'>Ignorado por cooldown ("+(now-last)+"ms &lt; "+COOLDOWN_MS+"ms): "+esc(vkey)+"</span>"; return; } LAST_SEEN[vkey]=now;
    registrarScan(item, code, {area:area,pos:pos,user:user,temporada:temporada}).then(function(){ var ex=(FOLIO_DOC && FOLIO_DOC.existenciasMap)||{}; var theo=Number(ex[vkey]||0); var prev=(COUNTS instanceof Map)? (COUNTS.get(vkey)||0):(COUNTS[vkey]||0); var nextScan=prev+1; var diff=nextScan-theo; if(COUNTS instanceof Map){ COUNTS.set(vkey,nextScan);} else { COUNTS[vkey]=nextScan; } $('lastItem').innerHTML = "<div class='flex flex-wrap items-center gap-2'>"+
      "<span class='font-semibold'>OK "+esc(item.mod)+" "+esc(item.color||'')+" "+esc(item.talla||'')+"</span>"+
      "<span class='text-xs'>("+esc(vkey)+") — "+esc(area)+(pos?(' · '+esc(pos)):'')+"</span>"+
      "<span class='ml-2 badge "+(diff===0?'bg-gray-100':(diff>0?'bg-green-100 text-emerald-700':'bg-red-100 text-red-700'))+"'>Teo: "+theo+" · Scan: "+nextScan+" · Dif: "+diff+"</span>"+
      "</div>"; beep(1000,70); haptic(25); }); }

  // ===== Realtime & Reporte =====
  function subscribeCounts(){ if(!FOLIO_ID) return; if(COUNTS instanceof Map){ COUNTS.clear(); } else { for(var x in COUNTS) if(Object.prototype.hasOwnProperty.call(COUNTS,x)) delete COUNTS[x]; }
    db.collection('folios').doc(FOLIO_ID).collection('counts').onSnapshot(function(snap){ snap.forEach(function(d){ var qty=d.data().qty||0; var id=d.id; if(COUNTS instanceof Map){ COUNTS.set(id, qty);} else { COUNTS[id]=qty; } }); }); }
  function subscribeScans(){ if(!FOLIO_ID) return; db.collection('folios').doc(FOLIO_ID).collection('scans').orderBy('ts','desc').limit(500).onSnapshot(function(snap){ var rows=[]; snap.forEach(function(d){ var x=d.data(); var dt=(x.ts && typeof x.ts.toDate==='function')? x.ts.toDate():new Date(); rows.push('<tr><td>'+fmt(dt)+'</td><td>'+esc(x.area||'')+'</td><td>'+esc(x.pos||'')+'</td><td>'+esc(x.code)+'</td><td>'+esc(x.mod||'')+'</td><td>'+esc(x.color||'')+'</td><td>'+esc(x.talla||'')+'</td><td>'+esc(x.user||x.operador||'')+'</td></tr>'); }); $('historyBody').innerHTML=rows.join(''); }); }
  function buildReportRows(byArea){ var ex=(FOLIO_DOC && FOLIO_DOC.existenciasMap)||{}; var rows=[]; var modF=(($('filtroModelo')&&$('filtroModelo').value)||'').trim().toUpperCase(); var colF=(($('filtroColor')&&$('filtroColor').value)||'').trim().toUpperCase(); var talF=(($('filtroTalla')&&$('filtroTalla').value)||'').trim().toUpperCase(); if(byArea){
      var areasKeys=[]; if(AGG_BY_AREA instanceof Map){ AGG_BY_AREA.forEach(function(_,k){ areasKeys.push(k); }); } else { for(var a in AGG_BY_AREA) if(Object.prototype.hasOwnProperty.call(AGG_BY_AREA,a)) areasKeys.push(a); }
      for(var ai=0; ai<areasKeys.length; ai++){ var area=areasKeys[ai]; var mods=(AGG_BY_AREA instanceof Map)? AGG_BY_AREA.get(area) : AGG_BY_AREA[area]; var keys=[]; if(mods instanceof Map){ mods.forEach(function(_,k){ keys.push(k); }); } else { for(var kk in mods) if(Object.prototype.hasOwnProperty.call(mods,kk)) keys.push(kk); }
        for(var ki=0; ki<keys.length; ki++){ var vkey=keys[ki]; var tmp=splitKey(vkey); if(modF && tmp.mod.toUpperCase().indexOf(modF)<0) continue; if(colF && (tmp.color||'').toUpperCase().indexOf(colF)<0) continue; if(talF && (tmp.talla||'').toUpperCase().indexOf(talF)<0) continue; var theo=Number(ex[vkey]||0); var scan = (mods instanceof Map)? (mods.get(vkey)||0):(mods[vkey]||0); rows.push({ area:area, mod:tmp.mod, color:tmp.color, talla:tmp.talla, theo:theo, scan:scan, diff:scan-theo }); }
      }
      rows.sort(function(a,b){ return (a.area||'').localeCompare(b.area||'') || a.mod.localeCompare(b.mod) || (a.color||'').localeCompare(b.color||'') || (a.talla||'').localeCompare(b.talla||''); });
      return rows;
    }
    var setKeys={}; for(var k in ex){ if(Object.prototype.hasOwnProperty.call(ex,k)) setKeys[k]=true; }
    if(COUNTS instanceof Map){ COUNTS.forEach(function(_,k){ setKeys[k]=true; }); } else { for(var ck in COUNTS) if(Object.prototype.hasOwnProperty.call(COUNTS,ck)) setKeys[ck]=true; }
    var keysAll=[]; for(var sk in setKeys) if(Object.prototype.hasOwnProperty.call(setKeys,sk)) keysAll.push(sk);
    for(var i=0;i<keysAll.length;i++){ var v=keysAll[i]; var o=splitKey(v); if(modF && o.mod.toUpperCase().indexOf(modF)<0) continue; if(colF && (o.color||'').toUpperCase().indexOf(colF)<0) continue; if(talF && (o.talla||'').toUpperCase().indexOf(talF)<0) continue; var theo2=Number(ex[v]||0); var scan2=(COUNTS instanceof Map)? (COUNTS.get(v)||0):(COUNTS[v]||0); rows.push({ area:'', mod:o.mod, color:o.color, talla:o.talla, theo:theo2, scan:scan2, diff:scan2-theo2 }); }
    rows.sort(function(a,b){ return a.mod.localeCompare(b.mod) || (a.color||'').localeCompare(b.color||'') || (a.talla||'').localeCompare(b.talla||''); });
    return rows; }
  function loadAggregatesByArea(){ if(!FOLIO_ID){ AGG_BY_AREA={}; return Promise.resolve(); } AGG_BY_AREA={}; var folio=db.collection('folios').doc(FOLIO_ID).collection('scans'); var page=1000; function pageFn(query){ return query.get().then(function(snap){ if(snap.empty) return; snap.forEach(function(doc){ var x=doc.data(); var area=(x.area||'').trim(); var vkey=x.vkey||keyOf(x.mod,x.color,x.talla); var mods=(AGG_BY_AREA instanceof Map)? (AGG_BY_AREA.get(area)||new Map()):(AGG_BY_AREA[area]||{}); var curr=(mods instanceof Map)? (mods.get(vkey)||0):(mods[vkey]||0); curr++; if(mods instanceof Map){ mods.set(vkey,curr);} else { mods[vkey]=curr; } if(AGG_BY_AREA instanceof Map){ AGG_BY_AREA.set(area,mods);} else { AGG_BY_AREA[area]=mods; } }); if(snap.size<page) return; var last=snap.docs[snap.size-1]; return pageFn(folio.orderBy('ts').startAfter(last).limit(page)); }); } return pageFn(folio.orderBy('ts').limit(page)); }
  function renderReport(){ var byArea=(($('groupMode')&&$('groupMode').value)==='area'); var rows=buildReportRows(byArea); var html=''; for(var i=0;i<rows.length;i++){ var r=rows[i]; html += '<tr><td>'+esc(r.area||'')+'</td><td>'+esc(r.mod)+'</td><td>'+esc(r.color||'')+'</td><td>'+esc(r.talla||'')+'</td><td class="text-right">'+r.theo+'</td><td class="text-right">'+r.scan+'</td><td class="text-right '+(r.diff===0?'':(r.diff>0?'text-emerald-600':'text-red-600'))+'">'+r.diff+'</td></tr>'; } $('reportBody').innerHTML=html; }
  on('btnRefrescarReporte','click', function(){ loadAggregatesByArea().then(renderReport); });
  on('btnExportarCSV','click', function(){ var rows=buildReportRows((($('groupMode')&&$('groupMode').value)==='area')); var csv=['Area,Modelo,Color,Talla,Teorico,Escaneado,Diferencia']; for(var i=0;i<rows.length;i++){ var r=rows[i]; csv.push([r.area||'',r.mod,r.color||'',r.talla||'',r.theo,r.scan,r.diff].join(',')); } var blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='reporte_'+(FOLIO_ID||'sin_folio')+'.csv'; a.click(); URL.revokeObjectURL(a.href); });
  on('btnBorrarArea','click', function(){ if(!FOLIO_ID) return alert('Sin folio'); var area=prompt('Área a borrar (borra todos los scans del área, máx 1000 docs por ejecución):'); if(!area) return; if(!confirm('¿Seguro de borrar scans del área '+area+'?')) return; db.collection('folios').doc(FOLIO_ID).collection('scans').where('area','==',area).limit(1000).get().then(function(q){ var batch=db.batch(); q.forEach(function(d){ batch.delete(d.ref); }); return batch.commit().then(function(){ alert('Borrados: '+q.size); }); }).catch(function(e){ alert('Error: '+(e.message||e)); }); });

  // ===== Diagnóstico =====
  on('btnDiag','click', function(){ var m=$('diagModal'); if(m){ m.classList.remove('hidden'); runDiagnostics(); } });
  on('btnDiagClose','click', function(){ var m=$('diagModal'); if(m) m.classList.add('hidden'); });
  function runDiagnostics(){ var lines=[]; try{ lines.push('Origen: '+location.origin); lines.push('Contexto seguro: '+window.isSecureContext); var dm=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||window.navigator.standalone; lines.push('PWA (standalone): '+ (!!dm)); lines.push('BarcodeDetector: '+ ('BarcodeDetector' in window)); var promises=[]; if('BarcodeDetector' in window && window.BarcodeDetector.getSupportedFormats){ try{ promises.push(window.BarcodeDetector.getSupportedFormats().then(function(fmts){ lines.push('Formatos BD: '+fmts.join(', ')); })); }catch(_){} } if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){ promises.push(navigator.mediaDevices.enumerateDevices().then(function(list){ var cams=[]; for(var i=0;i<list.length;i++){ if(list[i].kind==='videoinput') cams.push(list[i]); } lines.push('Cámaras: '+cams.length); for(var j=0;j<cams.length;j++){ var c=cams[j]; lines.push('  ['+j+'] '+(c.label||('Cam '+String(c.deviceId||'').slice(-4)))); } })); } if(activeTrack && activeTrack.getCapabilities){ try{ var caps=activeTrack.getCapabilities(); lines.push('Torch soportado: '+ (!!caps.torch)); if(caps.focusMode) lines.push('Enfoque: '+JSON.stringify(caps.focusMode)); }catch(_){ } } else { lines.push('Torch soportado: (iniciar cámara para verificar)'); } Promise.all(promises).then(function(){ $('diagContent').textContent=lines.join('\n'); }); }catch(e){ lines.push('Error diag: '+(e.message||e)); $('diagContent').textContent=lines.join('\n'); } }
})();
</script>
</body>
</html>
