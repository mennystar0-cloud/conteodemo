<!-- path: /index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="mobile-web-app-capable" content="yes" />
  <!-- (legacy iOS) mantener por compatibilidad: -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Conteo Cíclico</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%23000000'/%3E%3Ctext x='2' y='12' fill='%23ffffff' font-family='Arial' font-size='10'%3ECC%3C/text%3E%3C/svg%3E">
  <script>
    if ('serviceWorker' in navigator && window.isSecureContext) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>
  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Librerías locales (sin CORS). Sube estos archivos a /static de tu repo -->
  <script src="static/xlsx.full.min.js"></script>
  <script src="static/quagga.min.js"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-storage-compat.js"></script>
  <style>
    .btn{padding:.5rem .75rem;border-radius:.5rem;font-size:.875rem}
    .tab-btn{padding:.5rem .75rem;border-bottom:2px solid transparent}
    .card{background:#fff;padding:1rem;border-radius:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .cam{height:45vh;max-height:400px;background:#000;overflow:hidden;border-radius:1rem}
    th,td{padding:.35rem .5rem;border-bottom:1px solid #eee}
    .badge{border-radius:.5rem;padding:.1rem .5rem;font-size:.75rem}
    /* Alto contraste / XL (modo tienda) */
    .mode-xl body{background:#0b0b0b;color:#fff;}
    .mode-xl .card{background:#111827;color:#fff;}
    .mode-xl .btn{padding:0.9rem 1.1rem;font-size:1.125rem;border-width:2px;}
    .mode-xl .tab-btn{padding:.75rem 1rem;font-weight:600;}
    .mode-xl input,.mode-xl select,.mode-xl textarea{font-size:1.05rem;}
    .mode-xl .cam{height:60vh;max-height:none;}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-7xl mx-auto p-4">
  <header class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-xl font-bold">Conteo Cíclico — Catálogo + Existencias + Escaneo</h1>
      <p class="text-sm text-gray-600">Configuración en PC, escaneo en móviles por folio (PWA).</p>
    </div>
    <div class="text-sm text-gray-600">
      <span id="envInfo" class="badge bg-gray-100">Sin folio</span>
      <button id="btnInstall" class="btn bg-emerald-600 text-white hidden ml-2">Instalar app</button>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="flex flex-wrap gap-2 mb-4" id="tabs">
    <button data-tab="importar" class="tab-btn border-blue-600 text-blue-600">Importar</button>
    <button data-tab="existencias" class="tab-btn">Existencias</button>
    <button data-tab="folio" class="tab-btn">Folio</button>
    <button data-tab="escanear" class="tab-btn">Escanear</button>
    <button data-tab="reporte" class="tab-btn">Reporte</button>
    <button data-tab="consulta" class="tab-btn">Consulta</button>
    <button data-tab="historial" class="tab-btn">Historial</button>
  </nav>

  <!-- Importar catálogo -->
  <section id="tab-importar" class="block">
    <div class="card">
      <h2 class="font-semibold mb-2">Catálogo maestro (Local/PWA)</h2>
      <p class="text-sm text-gray-600">Lee <code>static/catalogo-master.xlsx</code> local (ideal para PWA/offline). Columnas: <code>CODIGO_BARRA</code>, <code>MOD</code>, <code>COLOR</code>, <code>TALLA</code>.</p>
      <div class="flex flex-wrap gap-2 mt-2 items-center">
        <button id="btnRecargarCloud" class="btn bg-blue-600 text-white">Recargar catálogo</button>
        <button id="btnForzarURL" class="btn bg-amber-500 text-white">Forzar URL única</button>
        <button id="btnPlantillaCSV" class="btn bg-gray-200">Descargar plantilla CSV</button>
        <span id="importStatus" class="text-sm text-gray-700">—</span>
      </div>
    </div>
  </section>

  <!-- Existencias -->
  <section id="tab-existencias" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Pegar existencias (teórico)</h2>
      <p class="text-sm text-gray-600">Formato por línea: <code>MODELO,COLOR TALLA CANTIDAD</code> (ej: <code>587-12,NEGRO 250 3</code>) o CSV <code>MODELO,COLOR,TALLA,CANTIDAD</code>.</p>
      <textarea id="existText" rows="8" class="w-full border rounded p-2" placeholder="Ejemplos&#10;587-12,NEGRO 250 3&#10;040-83,ANIMAL PRINT 230 3&#10;ABC-01,ROJO,27,2"></textarea>
      <div class="flex flex-wrap gap-2 mt-2 items-center">
        <button id="btnValidarExist" class="btn bg-gray-200">Validar</button>
        <button id="btnCargarExist" class="btn bg-green-600 text-white">Cargar al folio</button>
        <button id="btnLimpiarExist" class="btn bg-gray-200">Limpiar</button>
        <span id="existStatus" class="text-sm text-gray-700">—</span>
      </div>
      <div id="existPreview" class="mt-3 text-sm"></div>
    </div>
  </section>

  <!-- Folio -->
  <section id="tab-folio" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Folio</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <input id="folioName" class="border p-2 rounded w-full" placeholder="Nombre del folio" />
          <div class="grid grid-cols-2 gap-2">
            <input id="operador" class="border p-2 rounded" placeholder="¿Quién realiza el cíclico?" />
            <input id="almacen" class="border p-2 rounded" placeholder="Tipo de almacén (Sucursal / CEDIS / Bodega)" />
          </div>
          <select id="temporada" class="border p-2 rounded w-full">
            <option value="TODAS">Temporada: TODAS</option>
            <option value="LINEA">LÍNEA</option>
            <option value="OFERTA">OFERTA</option>
            <option value="SALDO">SALDO</option>
            <option value="PASO">PASO</option>
          </select>
          <div class="mt-2 flex gap-2">
            <button id="btnCrearFolio" class="btn bg-green-600 text-white">Crear folio</button>
            <button id="btnCerrarFolio" class="btn bg-gray-200" title="Cierra el folio actual">Cerrar folio</button>
          </div>
        </div>
        <div class="space-y-2">
          <input id="joinFolioId" class="border p-2 rounded w-full" placeholder="ID existente (000001)" />
          <div class="flex gap-2">
            <button id="btnUnirseFolio" class="btn bg-blue-600 text-white">Unirse</button>
            <button id="btnCopiarLink" class="btn bg-gray-200">Copiar link</button>
          </div>
          <div class="text-xs text-gray-600">Fecha creación: <span id="folioFecha">—</span></div>
        </div>
      </div>
      <div id="folioStatus" class="text-sm text-gray-600 mt-2">—</div>
    </div>
  </section>

  <!-- Escanear -->
  <section id="tab-escanear" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Escanear</h2>
      <div class="flex flex-wrap items-center gap-3 mb-3 text-sm">
        <label class="flex items-center gap-2"><input id="toggleXL" type="checkbox" class="h-4 w-4">Modo tienda (alto contraste / XL)</label>
        <label class="flex items-center gap-2"><input id="toggleSave" type="checkbox" class="h-4 w-4">Ahorro de batería (menos FPS)</label>
        <label class="flex items-center gap-2"><input id="toggleMute" type="checkbox" class="h-4 w-4">Silencio (sin beep/vibración)</label>
        <label class="flex items-center gap-2">Cooldown
          <input id="cooldownMs" type="number" min="0" step="100" value="800" class="border p-1 rounded w-24"> ms
        </label>
        <span id="fpsBadge" class="badge bg-gray-100">FPS: --</span>
        <span class="text-xs text-gray-500">Se guarda en este dispositivo</span>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="cam"><div id="interactive" class="viewport w-full h-full"></div></div>
          <div class="flex gap-2 mt-2 items-center">
            <select id="cameraSelect" class="border p-1"></select>
            <button id="btnRefreshCam" class="btn bg-gray-200">Refrescar cámaras</button>
            <button id="btnTorch" class="btn bg-gray-200">Linterna</button>
            <button id="btnStart" class="btn bg-blue-600 text-white">Iniciar</button>
            <button id="btnStop" class="btn bg-gray-200">Detener</button>
            <button id="btnDiag" class="btn bg-gray-200">Diagnóstico</button>
          </div>
        </div>
        <div>
          <div class="grid grid-cols-2 gap-2">
            <input id="scanArea" class="border p-2 rounded" placeholder="Área (persistente)" />
            <input id="scanPos"  class="border p-2 rounded" placeholder="Posición (persistente)" />
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <input id="scanOperador" class="border p-2 rounded" placeholder="Operador (persistente)" />
            </div>
          <label class="text-sm mt-2 block">Entrada manual</label>
          <input id="manualCode" class="border p-2 rounded w-full" placeholder="Pega un código y Enter" />
          <div id="lastItem" class="mt-2 text-sm text-gray-700">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal Diagnóstico -->
  <div id="diagModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-4 max-w-xl w-[90%]">
      <h3 class="font-semibold mb-2">Diagnóstico de cámara / entorno</h3>
      <div id="diagContent" class="text-sm whitespace-pre-wrap">Cargando…</div>
      <div class="mt-3 text-right">
        <button id="btnDiagClose" class="btn bg-gray-200">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Reporte -->
  <section id="tab-reporte" class="hidden">
    <div class="card">
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <h2 class="font-semibold">Reporte</h2>
        <select id="groupMode" class="ml-auto border p-1 rounded text-sm">
          <option value="general">General</option>
          <option value="area">Agrupar por área</option>
        </select>
        <input id="filtroModelo" class="border p-1 rounded text-sm" placeholder="Filtrar modelo" />
        <input id="filtroColor" class="border p-1 rounded text-sm" placeholder="Filtrar color" />
        <input id="filtroTalla" class="border p-1 rounded text-sm" placeholder="Filtrar talla" />
        <button id="btnRefrescarReporte" class="btn bg-blue-600 text-white">Refrescar</button>
        <button id="btnExportarCSV" class="btn bg-gray-200">Exportar CSV</button>
        <button id="btnBorrarArea" class="btn bg-red-600 text-white" title="Elimina scans por área (máx 1000)">Borrar por área</button>
      </div>
      <div class="overflow-auto max-h-[60vh]">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr>
              <th class="text-left">Área</th>
              <th class="text-left">Modelo</th>
              <th class="text-left">Color</th>
              <th class="text-left">Talla</th>
              <th class="text-right">Teórico</th>
              <th class="text-right">Escaneado</th>
              <th class="text-right">Diferencia</th>
            </tr>
          </thead>
          <tbody id="reportBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Consulta -->
  <section id="tab-consulta" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Consulta de modelo / color / talla</h2>
      <div class="grid md:grid-cols-4 gap-2">
        <input id="qModelo" class="border p-2 rounded" placeholder="Modelo" />
        <input id="qColor"  class="border p-2 rounded" placeholder="Color" />
        <input id="qTalla"  class="border p-2 rounded" placeholder="Talla" />
        <button id="btnBuscarModelo" class="btn bg-blue-600 text-white">Buscar</button>
      </div>
      <div class="overflow-auto max-h-[60vh] mt-3">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr>
              <th class="text-left">Fecha</th>
              <th class="text-left">Área</th>
              <th class="text-left">Posición</th>
              <th class="text-left">Operador</th>
              <th class="text-left">Temporada</th>
            </tr>
          </thead>
          <tbody id="consultaBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Historial -->
  <section id="tab-historial" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Historial</h2>
      <div class="overflow-auto max-h-[60vh]">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr>
              <th class="text-left">Fecha</th>
              <th class="text-left">Área</th>
              <th class="text-left">Posición</th>
              <th class="text-left">Código</th>
              <th class="text-left">Modelo</th>
              <th class="text-left">Color</th>
              <th class="text-left">Talla</th>
              <th class="text-left">Operador</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  // ===== Firebase init =====
  const firebaseConfig = {
    apiKey: "AIzaSyBe23iKn2bl0YMxsXUiTN5SkUrD9Vhvfo",
    authDomain: "cklass-conteo-ec4f5.firebaseapp.com",
    projectId: "cklass-conteo-ec4f5",
    storageBucket: "cklass-conteo-ec4f5.appspot.com",
    appId: "1:148726861241:web:592f683e941d13d2829e68"
  };
  if (!firebase.apps || firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
  const db=firebase.firestore(); const storage=firebase.storage();
  db.enablePersistence().catch(()=>{});

  // ===== Helpers =====
  const $=id=>document.getElementById(id);
  const on=(id,ev,fn)=>{const n=$(id); if(n) n.addEventListener(ev,fn);};
  const esc=s=>String(s).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
  const fmt=d=>{const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`};
  function canon(s){return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toUpperCase();}
  const keyOf=(mod,color,talla)=>`${(mod||'').trim()}|${(color||'').trim()}|${(talla||'').trim()}`;
  const splitKey=k=>{const [mod,color,talla]=String(k||'').split('|'); return {mod,color,talla};};

  // ===== PWA install prompt =====
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; const b=$('btnInstall'); if(b) b.classList.remove('hidden'); });
  window.addEventListener('appinstalled', ()=>{ const b=$('btnInstall'); if(b) b.classList.add('hidden'); deferredPrompt=null; });
  on('btnInstall','click', async ()=>{ if(!deferredPrompt){ if(/iphone|ipad|ipod/i.test(navigator.userAgent)){ alert('En iPhone: Compartir → "Añadir a pantalla de inicio".'); } return; } deferredPrompt.prompt(); try{ await deferredPrompt.userChoice; }catch(_){} const b=$('btnInstall'); if(b) b.classList.add('hidden'); deferredPrompt=null; });

  // ===== Tabs & persistentes =====
  function showTab(name){ ['importar','existencias','folio','escanear','reporte','consulta','historial'].forEach(t=>{ const el=$('tab-'+t); if(!el) return; el.classList.toggle('hidden',t!==name); el.classList.toggle('block',t===name); }); }
  window.addEventListener('DOMContentLoaded', function(){
    var tabs=document.querySelectorAll('#tabs [data-tab]');
    for(var i=0;i<tabs.length;i++){
      (function(btn){
        btn.addEventListener('click', function(){
          for(var j=0;j<tabs.length;j++){
            tabs[j].classList.remove('border-blue-600');
            tabs[j].classList.remove('text-blue-600');
          }
          btn.classList.add('border-blue-600');
          btn.classList.add('text-blue-600');
          showTab(btn.getAttribute('data-tab'));
        });
      })(tabs[i]);
    }
    var isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone;
    if (isStandalone || window.innerWidth < 768) { showTab('escanear'); } else { showTab('importar'); }
    var ids=['operador','almacen','temporada','scanArea','scanPos','scanOperador'];
    for(var k=0;k<ids.length;k++){
      var el=$(ids[k]); if(!el) continue; var v=localStorage.getItem('cc-'+ids[k]); if(v!==null) el.value=v;
      el.addEventListener('input', function(e){ localStorage.setItem('cc-'+e.target.id, e.target.value); });
      el.addEventListener('change', function(e){ localStorage.setItem('cc-'+e.target.id, e.target.value); });
    }
    var xlPref = localStorage.getItem('cc-mode-xl');
    var autoXL = (isStandalone || window.innerWidth < 768);
    var xlOn = (xlPref!==null) ? (xlPref==='1') : autoXL;
    document.documentElement.classList.toggle('mode-xl', !!xlOn);
    if($('toggleXL')) $('toggleXL').checked=!!xlOn;
    localStorage.setItem('cc-mode-xl', !!xlOn?'1':'0');
    var savePref = localStorage.getItem('cc-battery-save');
    var saveOn = (savePref!==null) ? (savePref==='1') : (window.innerWidth < 768);
    setBatterySave(!!saveOn);
    if($('toggleSave')) $('toggleSave').checked=!!saveOn;
    var mutePref = localStorage.getItem('cc-mute');
    var muteOn = (mutePref!==null) ? (mutePref==='1') : document.documentElement.classList.contains('mode-xl');
    MUTE = !!muteOn; if($('toggleMute')) $('toggleMute').checked = !!muteOn;
    var cdPref = localStorage.getItem('cc-cooldown');
    COOLDOWN_MS = isNaN(parseInt(cdPref||'',10)) ? 800 : parseInt(cdPref,10);
    if($('cooldownMs')) $('cooldownMs').value = COOLDOWN_MS;
  });
    tabs.forEach(btn=>btn.addEventListener('click',()=>{ tabs.forEach(b=>b.classList.remove('border-blue-600','text-blue-600')); btn.classList.add('border-blue-600','text-blue-600'); showTab(btn.dataset.tab); }));
    const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone; if (isStandalone || window.innerWidth < 768) { showTab('escanear'); } else { showTab('importar'); }
    ['operador','almacen','temporada','scanArea','scanPos','scanOperador'].forEach(id=>{ const el=$(id); if(!el) return; const v=localStorage.getItem('cc-'+id); if(v!==null) el.value=v; el.addEventListener('input',e=>localStorage.setItem('cc-'+id,e.target.value)); el.addEventListener('change',e=>localStorage.setItem('cc-'+id,e.target.value)); });
    // Modo tienda & ahorro
    let xlPref = localStorage.getItem('cc-mode-xl'); let autoXL = (isStandalone || window.innerWidth < 768); let xlOn = (xlPref!==null) ? (xlPref==='1') : autoXL; document.documentElement.classList.toggle('mode-xl', xlOn); if($('toggleXL')) $('toggleXL').checked=xlOn; localStorage.setItem('cc-mode-xl', xlOn?'1':'0');
    const savePref = localStorage.getItem('cc-battery-save'); const saveOn = (savePref!==null) ? (savePref==='1') : (window.innerWidth < 768); setBatterySave(saveOn); if($('toggleSave')) $('toggleSave').checked=saveOn;
    // Preferencias de silencio y cooldown
    const mutePref = localStorage.getItem('cc-mute');
    const muteOn = (mutePref!==null) ? (mutePref==='1') : document.documentElement.classList.contains('mode-xl');
    MUTE = muteOn; if($('toggleMute')) $('toggleMute').checked = muteOn;
    const cdPref = localStorage.getItem('cc-cooldown');
    COOLDOWN_MS = isNaN(parseInt(cdPref||'')) ? 800 : parseInt(cdPref,10);
    if($('cooldownMs')) $('cooldownMs').value = COOLDOWN_MS; setBatterySave(saveOn); if($('toggleSave')) $('toggleSave').checked=saveOn;
  });

  // ===== XLSX fallback =====
  function loadScript(url){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=url; s.onload=res; s.onerror=()=>rej(new Error('No se pudo cargar: '+url)); document.head.appendChild(s); }); }
  function ensureXLSX(){ if(window.XLSX) return Promise.resolve(); const cdns=['https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js','https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js','https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js']; let i=0; function next(){ if(window.XLSX) return Promise.resolve(); if(i>=cdns.length) return Promise.reject(new Error('XLSX no disponible')); return loadScript(cdns[i++]).then(()=>{ if(!window.XLSX) return next(); }); } return next(); }

  // ===== Catálogo local =====
  let CATALOGO = { byBarcode:new Map(), byVariant:new Map() };
  function buildCatalog(rows){ const res={ byBarcode:new Map(), byVariant:new Map() }; const H=(rows[0]||[]).map(canon); const idx=names=>{ for(let j=0;j<names.length;j++){ const i=H.indexOf(canon(names[j])); if(i>=0) return i; } return -1; }; const iCode=idx(['CODIGO_BARRA','CODIGO','EAN','UPC']); const iMod =idx(['MOD','MODELO','SKU']); const iColor=idx(['COLOR']); const iTalla=idx(['TALLA']); for(let r=1;r<rows.length;r++){ const row=rows[r]||[]; const code=String(row[iCode]||'').trim(); const mod=String(row[iMod]||'').trim(); const color=String(row[iColor]||'').trim(); const talla=String(row[iTalla]||'').trim(); if(!code||!mod) continue; const vkey=keyOf(mod,color,talla); const item={mod,color,talla,vkey}; res.byBarcode.set(code,item); if(!res.byVariant.has(vkey)) res.byVariant.set(vkey,item); } return res; }
  function cargarCatalogo(force){ $('importStatus').textContent='Descargando...'; const url='static/catalogo-master.xlsx'+(force?('?v='+Date.now()):''); fetch(url,{cache:'no-store'}).then(resp=>{ if(!resp.ok) throw new Error('HTTP '+resp.status); return resp.arrayBuffer(); }).then(ab=>ensureXLSX().then(()=>ab)).then(ab=>{ const wb=XLSX.read(ab,{type:'array'}); const sh=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(sh,{header:1,defval:''}); CATALOGO=buildCatalog(rows); $('importStatus').textContent=`Catálogo OK: ${rows.length-1} filas (hoja: ${wb.SheetNames[0]}) · Origen: local`; }).catch(e=>{ console.error(e); $('importStatus').textContent='Error: '+(e.message||e); }); }
  on('btnRecargarCloud','click',()=>cargarCatalogo(false));
  on('btnForzarURL','click',()=>cargarCatalogo(true));
  on('btnPlantillaCSV','click',()=>{ const csv=`MODELO,COLOR,TALLA,CANTIDAD\n587-12,NEGRO,250,3\n`; const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plantilla_existencias.csv'; a.click(); URL.revokeObjectURL(a.href); });

  // ===== Folio =====
  let FOLIO_ID=null; let FOLIO_DOC=null; let COUNTS=new Map(); let AGG_BY_AREA=new Map();
  function nextFolioNumber(){
    const ref=db.collection('meta').doc('counters');
    return db.runTransaction(function(tx){
      return tx.get(ref).then(function(snap){
        const cur = snap.exists ? (snap.data().nextFolio||1) : 1;
        tx.set(ref,{nextFolio:cur+1},{merge:true});
        return cur;
      });
    });
  },{merge:true}); return cur; }); return n; }
  function req(input,msg){
    var val;
    if (typeof input === 'string') { val = input; }
    else if (input && typeof input === 'object' && 'value' in input) { val = input.value; }
    else { val = input; }
    var s = String(val||'').trim();
    if(!s){ alert(msg); throw new Error(msg); }
    return s;
  } return val.trim(); }
  function crearFolio(){
    try{
      const name=($('#folioName')?.value||'Cíclico').trim()||'Cíclico';
      const operador=req($('#operador'),'Indica quién realiza el cíclico');
      const almacen=req($('#almacen'),'Indica el tipo de almacén');
      const temporada=$('#temporada')?.value||'TODAS';
      return nextFolioNumber().then(function(number){
        const id=String(number).padStart(6,'0');
        const ref=db.collection('folios').doc(id);
        return ref.set({ id, number, name, createdBy:operador, almacen, temporada, state:'open', existenciasMap:{}, createdAt: firebase.firestore.FieldValue.serverTimestamp() })
          .then(function(){ return activarFolio(id); });
      }).catch(function(e){ console.warn(e && e.message ? e.message : e); });
    }catch(e){ console.warn(e && e.message ? e.message : e); return Promise.resolve(); }
  }, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); await activarFolio(id); }catch(e){ console.warn(e.message||e); }}
  function activarFolio(id){
    return db.collection('folios').doc(id).get().then(function(snap){
      if(!snap.exists){ alert('Folio no encontrado'); return; }
      FOLIO_ID=id; FOLIO_DOC=snap.data();
      $('envInfo').textContent='Folio '+id;
      $('joinFolioId').value=id;
      var dt = (FOLIO_DOC && FOLIO_DOC.createdAt && typeof FOLIO_DOC.createdAt.toDate === 'function') ? FOLIO_DOC.createdAt.toDate() : new Date();
      $('folioFecha').textContent=fmt(dt);
      $('folioStatus').innerHTML=`Folio: <b>${id}</b> — ${esc(FOLIO_DOC.name||'')} · Operador: ${esc(FOLIO_DOC.createdBy||'')} · Almacén: ${esc(FOLIO_DOC.almacen||'')} · Temporada: ${esc(FOLIO_DOC.temporada||'')}`;
      document.title='Folio '+id+' · Conteo Cíclico';
      subscribeCounts(); subscribeScans();
    });
  }</b> — ${esc(FOLIO_DOC.name||'')} · Operador: ${esc(FOLIO_DOC.createdBy||'')} · Almacén: ${esc(FOLIO_DOC.almacen||'')} · Temporada: ${esc(FOLIO_DOC.temporada||'')}`; document.title='Folio '+id+' · Conteo Cíclico'; subscribeCounts(); subscribeScans(); }
  function unirseFolio(){ const id=($('#joinFolioId')?.value||'').trim(); if(!id) return; return activarFolio(id); }
  on('btnCrearFolio','click',crearFolio);
  on('btnUnirseFolio','click',unirseFolio);
  on('btnCopiarLink','click',()=>{ if(!FOLIO_ID) return; const u=new URL(location.href); u.searchParams.set('folio',FOLIO_ID); navigator.clipboard.writeText(u.toString()); alert('Link copiado'); });
  on('btnCerrarFolio','click', function(){ if(!FOLIO_ID) return; db.collection('folios').doc(FOLIO_ID).update({state:'closed'}).then(function(){ alert('Folio cerrado'); }); }); alert('Folio cerrado'); });

  // ===== Existencias =====
  on('btnLimpiarExist','click',()=>{ $('existText').value=''; $('existStatus').textContent='—'; $('existPreview').innerHTML=''; });
  on('btnValidarExist','click',()=>renderExistPreview(parseExistencias($('existText').value||'')));
  on('btnCargarExist','click',function(){
    try{
      if(!FOLIO_ID) return alert('Crea/Activa un folio');
      const res=parseExistencias($('existText').value||'');
      const map=res.map; if(Object.keys(map).length===0) return alert('No hay líneas válidas');
      db.collection('folios').doc(FOLIO_ID)
        .set({ existenciasMap: map, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },{merge:true})
        .then(function(){ $('existStatus').textContent=`Cargadas ${Object.keys(map).length} variantes (pzs: ${res.total})`; })
        .catch(function(e){ console.error(e); $('existStatus').textContent='Error: '+(e.message||e); });
    }catch(e){ console.error(e); $('existStatus').textContent='Error: '+(e.message||e); }
  }); $('existStatus').textContent=`Cargadas ${Object.keys(map).length} variantes (pzs: ${res.total})`; }catch(e){ console.error(e); $('existStatus').textContent='Error: '+(e.message||e); } });
  function parseExistencias(text){ const out={}, bad=[]; const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean); for(let i=0;i<lines.length;i++){ const ln=lines[i]; const parts=ln.split(','); if(parts.length===4){ const mod=parts[0].trim(); const color=parts[1].trim(); const talla=parts[2].trim(); const qty=parseInt(String(parts[3]).trim(),10); if(mod && color && talla && !isNaN(qty)){ const k=keyOf(mod,color,talla); out[k]=(out[k]||0)+qty; continue; } } if(ln.indexOf(',')>=0){ const first=ln.indexOf(','); const mod2=ln.slice(0,first).trim(); const rest=ln.slice(first+1).trim(); const mQty=rest.match(/(\d+)\s*$/); if(mQty){ const qty2=parseInt(mQty[1],10); const rest2=rest.slice(0,mQty.index).trim(); const mTalla=rest2.match(/([A-Za-z0-9_.\-]+)\s*$/); if(mTalla){ const talla2=mTalla[1]; const color2=rest2.slice(0,rest2.length-mTalla[0].length).trim(); if(mod2 && color2 && talla2 && !isNaN(qty2)){ const k2=keyOf(mod2,color2,talla2); out[k2]=(out[k2]||0)+qty2; continue; } } } } bad.push({line:i+1, text:ln}); } let total=0; Object.keys(out).forEach(k=>{ total+=out[k]; }); return {map:out, bad:bad, total:total}; }
  function renderExistPreview(res){ const rows=Object.entries(res.map).slice(0,600).map(([k,qty])=>{ const {mod,color,talla}=splitKey(k); return `<tr><td>${esc(mod)}</td><td>${esc(color)}</td><td>${esc(talla)}</td><td class=\"text-right\">${qty}</td></tr>`; }).join(''); const bads=res.bad.map(b=>`<li>L${b.line}: ${esc(b.text)}</li>`).join(''); $('existPreview').innerHTML = `\
    <div class='mt-2'>\
      <div class='text-sm'>Variantes válidas: <b>${Object.keys(res.map).length}</b> · Pzs: <b>${res.total}</b> ${res.bad.length?`· Inválidas: <b class='text-red-600'>${res.bad.length}</b>`:''}</div>\
      <div class='grid md:grid-cols-2 gap-4 mt-2'>\
        <div class='overflow-auto max-h-[40vh]'>\
          <table class='w-full text-sm'><thead><tr><th>Modelo</th><th>Color</th><th>Talla</th><th class='text-right'>Cant</th></tr></thead><tbody>${rows}</tbody></table>\
        </div>\
        <div>\
          ${res.bad.length?`<h3 class='font-semibold mb-1'>Líneas inválidas</h3><ul class='list-disc pl-5 text-red-600 text-sm'>${bads}</ul>`:"<div class='text-sm text-emerald-700'>Sin errores</div>"}\
        </div>\
      </div>\
    </div>`; }

  // ===== Realtime =====
  function subscribeCounts(){ if(!FOLIO_ID) return; COUNTS.clear(); db.collection('folios').doc(FOLIO_ID).collection('counts').onSnapshot(snap=>{ snap.forEach(d=>COUNTS.set(d.id, d.data().qty||0)); }); }
  function subscribeScans(){ if(!FOLIO_ID) return; db.collection('folios').doc(FOLIO_ID).collection('scans').orderBy('ts','desc').limit(500).onSnapshot(snap=>{ const rows=[]; snap.forEach(d=>{const x=d.data(); const dt=x.ts?.toDate?x.ts.toDate():new Date(); rows.push(`<tr><td>${fmt(dt)}</td><td>${esc(x.area||'')}</td><td>${esc(x.pos||'')}</td><td>${esc(x.code)}</td><td>${esc(x.mod||'')}</td><td>${esc(x.color||'')}</td><td>${esc(x.talla||'')}</td><td>${esc(x.user||x.operador||'')}</td></tr>`);}); $('historyBody').innerHTML=rows.join(''); }); }

  // ===== GS1 mínima =====
  function computeEAN13CheckDigit(d12){const a=d12.split('').map(Number);let s=0;for(let i=0;i<12;i++) s+=a[i]*(i%2?3:1);return String((10-(s%10))%10)}
  function toEAN13FromGTIN14(gt){if(!/^\d{14}$/.test(gt)) return null; const b=gt.slice(1,13); return b+computeEAN13CheckDigit(b)}
  function normalizeBarcode(raw){const s=String(raw).trim(); if(/^\d{13}$/.test(s)){const cd=computeEAN13CheckDigit(s.slice(0,12)); return {ean13:s.slice(0,12)+cd};} if(/^\d{12}$/.test(s)) return {ean13:'0'+s}; if(/^\d{14}$/.test(s)) return {ean13:toEAN13FromGTIN14(s)}; return {raw:s};}

  // ===== Haptic/Beep + FPS =====
  let MUTE=false; // preferencia de tienda
  let COOLDOWN_MS=800; // antirrebote por producto
  const LAST_SEEN=new Map(); // vkey -> timestamp ms
  let audioCtx=null; function ensureAudio(){ try{ if(!audioCtx){ const AC=window.AudioContext||window.webkitAudioContext; if(AC) audioCtx=new AC(); } }catch(e){} }
  function beep(freq, ms){
    if(MUTE) return; // evitar sonidos en tienda
    if(!audioCtx) return;
    try{
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.frequency.value=freq; g.gain.value=0.045;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(_){} }, ms||80);
    }catch(_){ }
  }
  function haptic(pattern){ if(MUTE) return; try{ if(navigator.vibrate) navigator.vibrate(pattern||25); }catch(_){ } }
  const fpsTicker={on:false}; let fpsRaf=0, fpsCnt=0, fpsLast=0; function startFpsMonitor(){ if(fpsTicker.on) return; fpsTicker.on=true; fpsCnt=0; fpsLast=performance.now(); const step=(t)=>{ if(!fpsTicker.on) return; fpsCnt++; if(t - fpsLast >= 1000){ const el=$('fpsBadge'); if(el) el.textContent='FPS: '+fpsCnt; fpsCnt=0; fpsLast=t; } fpsRaf=requestAnimationFrame(step); }; fpsRaf=requestAnimationFrame(step);} function stopFpsMonitor(){ if(fpsRaf) cancelAnimationFrame(fpsRaf); fpsTicker.on=false; const el=$('fpsBadge'); if(el) el.textContent='FPS: --'; }

  // ===== Escáner (BarcodeDetector → Quagga) =====
  let scanning=false, activeTrack=null, TORCH=false, lastDetect=0;
  let BATTERY_SAVE=false, PROC_INTERVAL_MS=80, lastProc=0;
  function setBatterySave(on){ BATTERY_SAVE=!!on; PROC_INTERVAL_MS = BATTERY_SAVE? 280:80; localStorage.setItem('cc-battery-save', BATTERY_SAVE?'1':'0'); }
  let bdDetector=null, rafId=0, videoEl=null, canvasEl=null, ctx=null;
  const hasBarcodeDetector = ()=>('BarcodeDetector' in window);
  function getVideoConstraints(devId){ const base={ facingMode:{ ideal:'environment' }, width:{ ideal:1280 }, height:{ ideal:720 }, frameRate: BATTERY_SAVE? {ideal:15,max:15}:{ideal:30,max:30} }; return devId? { deviceId:{exact:devId}, width:base.width, height:base.height, frameRate:base.frameRate } : base; }
  function setupVideo(devId){ const constraints={ video: getVideoConstraints(devId) }; return navigator.mediaDevices.getUserMedia(constraints).then(stream=>{ const container=document.getElementById('interactive'); container.innerHTML=''; const v=document.createElement('video'); v.autoplay=true; v.playsInline=true; v.muted=true; v.style.width='100%'; v.style.height='100%'; v.srcObject=stream; container.appendChild(v); activeTrack=stream.getVideoTracks()[0]; videoEl=v; canvasEl=document.createElement('canvas'); ctx=canvasEl.getContext('2d'); return new Promise(res=>{ v.onloadedmetadata=function(){ v.play(); res(v); }; }); }); }
  function startLoopDetect(){ function loop(){ if(!scanning) return; if(videoEl && videoEl.readyState>=2){ const now=Date.now(); if(now - lastProc >= PROC_INTERVAL_MS){ lastProc=now; const w=Math.min(640, videoEl.videoWidth||640), h=Math.min(480, videoEl.videoHeight||480); canvasEl.width=w; canvasEl.height=h; ctx.drawImage(videoEl,0,0,w,h); bdDetector.detect(canvasEl).then(codes=>{ if(!codes || !codes.length) return; if(now-lastDetect<400) return; lastDetect=now; const code=(codes[0].rawValue||'').trim(); if(code) handleBarcode(code); }).catch(()=>{}); } } rafId=requestAnimationFrame(loop); } loop(); }
  function startNativeDetector(){ const devId=$('cameraSelect').value||undefined; return setupVideo(devId).then(()=>{ if(!bdDetector){ try{ bdDetector=new BarcodeDetector({formats:['ean_13','ean_8','upc_e','upc_a','code_128']}); }catch(e){ return Promise.reject(e); } } }).then(()=>{ scanning=true; startFpsMonitor(); startLoopDetect(); }).catch(e=>{ console.warn('BarcodeDetector falló, usando Quagga', e); return startQuagga(); }); }
  function startQuagga(){ return new Promise(resolve=>{ if(!window.Quagga){ alert('Quagga no disponible'); resolve(); return; } const devId=$('cameraSelect').value||undefined; Quagga.init({ inputStream:{ name:'Live', type:'LiveStream', target: document.querySelector('#interactive'), constraints: devId? {deviceId:devId}:{ facingMode:'environment'} }, decoder:{ readers:['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader'] }, locate:true }, function(err){ if(err){ console.error(err); alert('No se pudo iniciar cámara'); resolve(); return; } scanning=true; Quagga.start(); startFpsMonitor(); setTimeout(()=>{ try{ const v=document.querySelector('#interactive video'); activeTrack=v && v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks()[0]:null; }catch(e){} },300); Quagga.onDetected(function(res){ const now=Date.now(); if(now-lastDetect<400) return; lastDetect=now; const code=(res && res.codeResult && res.codeResult.code || '').trim(); if(code) handleBarcode(code); }); resolve(); }); }); }
  on('btnRefreshCam','click',()=>{ navigator.mediaDevices.enumerateDevices().then(list=>{ const cams=list.filter(d=>d.kind==='videoinput'); $('cameraSelect').innerHTML=cams.map(d=>`<option value="${d.deviceId}">${d.label||('Cam '+d.deviceId.slice(-4))}</option>`).join(''); }); });
  on('btnStart','click',()=>{ if(scanning) return; ensureAudio(); (hasBarcodeDetector()? startNativeDetector(): startQuagga()).catch(e=>{ console.error(e); alert('Permite el acceso a la cámara.'); }); });
  function stopScanner(){ try{ if(rafId) cancelAnimationFrame(rafId); stopFpsMonitor(); if(videoEl && videoEl.srcObject){ videoEl.srcObject.getTracks().forEach(t=>t.stop()); } if(window.Quagga){ try{ Quagga.stop(); }catch(e){} } }catch(e){} scanning=false; activeTrack=null; TORCH=false; }
  on('btnStop','click',stopScanner);
  on('btnTorch','click',()=>{ try{ if(!activeTrack){ const v=document.querySelector('#interactive video'); if(v && v.srcObject && v.srcObject.getVideoTracks){ const t=v.srcObject.getVideoTracks(); activeTrack=(t && t[0])? t[0]:null; } } if(!activeTrack) return alert('Inicia la cámara'); const caps=activeTrack.getCapabilities && activeTrack.getCapabilities(); if(!caps || !caps.torch) return alert('Linterna no soportada'); TORCH=!TORCH; activeTrack.applyConstraints({advanced:[{torch: TORCH}]}); }catch(e){ alert('Linterna no soportada'); }});
  on('btnDiag','click',()=>{ const m=$('diagModal'); if(m){ m.classList.remove('hidden'); runDiagnostics(); } });
  on('btnDiagClose','click',()=>{ const m=$('diagModal'); if(m) m.classList.add('hidden'); });
  function runDiagnostics(){
    const lines=[];
    try{
      lines.push('Origen: '+location.origin);
      lines.push('Contexto seguro: '+window.isSecureContext);
      const dm = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone;
      lines.push('PWA (standalone): '+ (!!dm));
      lines.push('BarcodeDetector: '+ ('BarcodeDetector' in window));
      var promises=[];
      if ('BarcodeDetector' in window && window.BarcodeDetector.getSupportedFormats){
        try{ promises.push(window.BarcodeDetector.getSupportedFormats().then(function(fmts){ lines.push('Formatos BD: '+fmts.join(', ')); })); }catch(_){ }
      }
      if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){
        promises.push(navigator.mediaDevices.enumerateDevices().then(function(list){
          const cams = list.filter(function(d){return d.kind==='videoinput';});
          lines.push('Cámaras: '+cams.length);
          cams.forEach(function(c,i){ lines.push('  ['+i+'] '+(c.label||('Cam '+String(c.deviceId||'').slice(-4)))); });
        }));
      }
      if (activeTrack && activeTrack.getCapabilities){
        try{
          const caps = activeTrack.getCapabilities();
          lines.push('Torch soportado: '+ (!!caps.torch));
          if (caps.focusMode) lines.push('Enfoque: '+JSON.stringify(caps.focusMode));
        }catch(_){}
      } else {
        lines.push('Torch soportado: (iniciar cámara para verificar)');
      }
      Promise.all(promises).then(function(){ $('diagContent').textContent = lines.join('
'); });
    }catch(e){ lines.push('Error diag: '+(e.message||e)); $('diagContent').textContent = lines.join('
'); }
  }`);
      lines.push(`Contexto seguro: ${window.isSecureContext}`);
      const dm = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone;
      lines.push(`PWA (standalone): ${!!dm}`);
      lines.push(`BarcodeDetector: ${'BarcodeDetector' in window}`);
      if ('BarcodeDetector' in window && window.BarcodeDetector.getSupportedFormats){
        try{ const fmts=await window.BarcodeDetector.getSupportedFormats(); lines.push('Formatos BD: '+fmts.join(', ')); }catch(_){ }
      }
      if (navigator.mediaDevices?.enumerateDevices){
        const list = await navigator.mediaDevices.enumerateDevices();
        const cams = list.filter(d=>d.kind==='videoinput');
        lines.push(`Cámaras: ${cams.length}`);
        cams.forEach((c,i)=>lines.push(`  [${i}] ${c.label||('Cam '+(c.deviceId||'').slice(-4))}`));
      }
      if (activeTrack && activeTrack.getCapabilities){
        const caps = activeTrack.getCapabilities();
        lines.push(`Torch soportado: ${!!caps.torch}`);
        if (caps.focusMode) lines.push(`Enfoque: ${JSON.stringify(caps.focusMode)}`);
      } else {
        lines.push('Torch soportado: (iniciar cámara para verificar)');
      }
    }catch(e){ lines.push('Error diag: '+(e.message||e)); }
    $('diagContent').textContent = lines.join('
');
  } if(v && v.srcObject && v.srcObject.getVideoTracks){ const t=v.srcObject.getVideoTracks(); activeTrack=(t && t[0])? t[0]:null; } } if(!activeTrack) return alert('Inicia la cámara'); const caps=activeTrack.getCapabilities && activeTrack.getCapabilities(); if(!caps || !caps.torch) return alert('Linterna no soportada'); TORCH=!TORCH; activeTrack.applyConstraints({advanced:[{torch: TORCH}]}); }catch(e){ alert('Linterna no soportada'); }});
  on('toggleXL','change', e=>{ const on=e.target.checked; document.documentElement.classList.toggle('mode-xl', on); localStorage.setItem('cc-mode-xl', on?'1':'0'); });
  on('toggleSave','change', e=>{ const on=e.target.checked; const was=scanning; setBatterySave(on); if(was){ stopScanner(); (hasBarcodeDetector()? startNativeDetector(): startQuagga()); } });
  on('toggleMute','change', e=>{ MUTE=!!e.target.checked; localStorage.setItem('cc-mute', MUTE?'1':'0'); });
  on('cooldownMs','change', e=>{ let v=parseInt(e.target.value,10); if(isNaN(v)||v<0) v=0; COOLDOWN_MS=v; localStorage.setItem('cc-cooldown', String(v)); }); if(was){ stopScanner(); (hasBarcodeDetector()? startNativeDetector(): startQuagga()); } });
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden && scanning){ stopScanner(); } });

  // ===== Registro de scan =====
  function registrarScan(item, code, meta){
    if(!FOLIO_ID) return Promise.reject(new Error('No folio'));
    const refFol = db.collection('folios').doc(FOLIO_ID);
    const vkey = item.vkey || keyOf(item.mod,item.color,item.talla);
    const scanDoc = { ts: firebase.firestore.FieldValue.serverTimestamp(), code:String(code), vkey:vkey, mod:item.mod, color:item.color||'', talla:item.talla||'', area:meta.area||'', pos:meta.pos||'', user:meta.user||meta.operador||'', temporada:meta.temporada||'' };
    return refFol.collection('scans').add(scanDoc)
      .then(function(){ return refFol.collection('counts').doc(vkey).set({qty: firebase.firestore.FieldValue.increment(1)}, {merge:true}); });
  }; await refFol.collection('scans').add(scanDoc); await refFol.collection('counts').doc(vkey).set({qty: firebase.firestore.FieldValue.increment(1)}, {merge:true}); }
  function handleBarcode(code){
    if(!FOLIO_ID){ beep(220,120); haptic([60]); return alert('Sin folio'); }
    if(CATALOGO.byBarcode.size===0){ beep(220,120); haptic([60]); return alert('Catálogo no cargado'); }
    const n=normalizeBarcode(code);
    const key=n.ean13||code;
    const item=CATALOGO.byBarcode.get(key)||CATALOGO.byBarcode.get(String(code));
    if(!item){ $('lastItem').textContent='No encontrado: '+code; beep(220,140); haptic([40,60,40]); return; }
    const area=((document.getElementById('scanArea') && document.getElementById('scanArea').value) || '').trim();
    const pos =((document.getElementById('scanPos') && document.getElementById('scanPos').value) || '').trim();
    const user=((document.getElementById('scanOperador') && document.getElementById('scanOperador').value) || (document.getElementById('operador') && document.getElementById('operador').value) || (FOLIO_DOC && FOLIO_DOC.createdBy) || '').trim();
    var temporada = (FOLIO_DOC && FOLIO_DOC.temporada) ? FOLIO_DOC.temporada : 'TODAS';
    const vkey=item.vkey||keyOf(item.mod,item.color,item.talla);
    const now=Date.now();
    const last=LAST_SEEN.get(vkey)||0;
    if(now - last < COOLDOWN_MS){
      $('lastItem').innerHTML = `<span class='text-xs text-gray-500'>Ignorado por cooldown (${now-last}ms &lt; ${COOLDOWN_MS}ms): ${esc(vkey)}</span>`;
      return;
    }
    LAST_SEEN.set(vkey, now);
    registrarScan(item, code, {area,pos,user,temporada}).then(()=>{
      const theo = Number((FOLIO_DOC && FOLIO_DOC.existenciasMap && FOLIO_DOC.existenciasMap[vkey]) || 0);
      const nextScan = Number((COUNTS.get(vkey)||0) + 1);
      const diff = nextScan - theo;
      COUNTS.set(vkey, nextScan);
      $('lastItem').innerHTML = `
        <div class="flex flex-wrap items-center gap-2">
          <span class="font-semibold">OK ${esc(item.mod)} ${esc(item.color||'')} ${esc(item.talla||'')}</span>
          <span class="text-xs">(${esc(vkey)}) — ${esc(area)}${pos?(' · '+esc(pos)) : ''}</span>
          <span class="ml-2 badge ${diff===0?'bg-gray-100':(diff>0?'bg-green-100 text-emerald-700':'bg-red-100 text-red-700')}">Teo: ${theo} · Scan: ${nextScan} · Dif: ${diff}</span>
        </div>`;
      beep(1000,70); haptic(25);
    });
  }
    if(CATALOGO.byBarcode.size===0){ beep(220,120); haptic([60]); return alert('Catálogo no cargado'); }
    const n=normalizeBarcode(code);
    const key=n.ean13||code;
    const item=CATALOGO.byBarcode.get(key)||CATALOGO.byBarcode.get(String(code));
    if(!item){ $('lastItem').textContent='No encontrado: '+code; beep(220,140); haptic([40,60,40]); return; }
    const area=($('#scanArea')?.value||'').trim();
    const pos =($('#scanPos')?.value||'').trim();
    const user=($('#scanOperador')?.value||$('#operador')?.value||(FOLIO_DOC&&FOLIO_DOC.createdBy)||'').trim();
    const temporada=FOLIO_DOC?.temporada||'TODAS';
    const vkey=item.vkey||keyOf(item.mod,item.color,item.talla);
    registrarScan(item, code, {area,pos,user,temporada}).then(()=>{
      const theo = Number((FOLIO_DOC && FOLIO_DOC.existenciasMap && FOLIO_DOC.existenciasMap[vkey]) || 0);
      const nextScan = Number((COUNTS.get(vkey)||0) + 1);
      const diff = nextScan - theo;
      COUNTS.set(vkey, nextScan);
      $('lastItem').innerHTML = `
        <div class="flex flex-wrap items-center gap-2">
          <span class="font-semibold">OK ${esc(item.mod)} ${esc(item.color||'')} ${esc(item.talla||'')}</span>
          <span class="text-xs">(${esc(vkey)}) — ${esc(area)}${pos?(' · '+esc(pos)) : ''}</span>
          <span class="ml-2 badge ${diff===0?'bg-gray-100':(diff>0?'bg-green-100 text-emerald-700':'bg-red-100 text-red-700')}">Teo: ${theo} · Scan: ${nextScan} · Dif: ${diff}</span>
        </div>`;
      beep(1000,70); haptic(25);
    });
  }
  on('manualCode','keydown',e=>{ if(e.key==='Enter'){ const v=e.target.value.trim(); if(v) handleBarcode(v); e.target.value=''; }});

  // ===== Reporte =====
  on('btnRefrescarReporte','click', function(){ loadAggregatesByArea().then(renderReport); }); renderReport(); });
  on('btnExportarCSV','click',()=>{ const rows = buildReportRows($('groupMode').value==='area'); const csv=['Area,Modelo,Color,Talla,Teorico,Escaneado,Diferencia'].concat(rows.map(r=>[r.area||'',r.mod,r.color||'',r.talla||'',r.theo,r.scan,r.diff].join(','))).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`reporte_${FOLIO_ID||'sin_folio'}.csv`; a.click(); URL.revokeObjectURL(a.href); });
  on('btnBorrarArea','click', function(){
    if(!FOLIO_ID) return alert('Sin folio');
    const area=prompt('Área a borrar (borra todos los scans del área, máx 1000 docs por ejecución):');
    if(!area) return; if(!confirm('¿Seguro de borrar scans del área '+area+'?')) return;
    db.collection('folios').doc(FOLIO_ID).collection('scans').where('area','==',area).limit(1000).get()
      .then(function(q){ const batch=db.batch(); q.forEach(function(d){ batch.delete(d.ref); }); return batch.commit().then(function(){ alert('Borrados: '+q.size); }); })
      .catch(function(e){ alert('Error: '+(e.message||e)); });
  }); const area=prompt('Área a borrar (máx 1000 docs por ejecución):'); if(!area) return; if(!confirm('¿Seguro de borrar scans del área '+area+'?')) return; const q=await db.collection('folios').doc(FOLIO_ID).collection('scans').where('area','==',area).limit(1000).get(); const batch=db.batch(); q.forEach(d=>batch.delete(d.ref)); await batch.commit(); alert('Borrados: '+q.size); });
  function buildReportRows(byArea){ var ex = (FOLIO_DOC && FOLIO_DOC.existenciasMap) || {}; const rows=[]; const modF=($('#filtroModelo')?.value||'').trim().toUpperCase(); const colF=($('#filtroColor')?.value||'').trim().toUpperCase(); const talF=($('#filtroTalla')?.value||'').trim().toUpperCase(); if(byArea){ AGG_BY_AREA.forEach((mods, area)=>{ mods.forEach((scan, vkey)=>{ const {mod,color,talla}=splitKey(vkey); if(modF && !mod.toUpperCase().includes(modF)) return; if(colF && !(color||'').toUpperCase().includes(colF)) return; if(talF && !(talla||'').toUpperCase().includes(talF)) return; const theo=Number(ex[vkey]||0); rows.push({ area, mod, color, talla, theo, scan, diff: scan-theo }); }); }); return rows.sort((a,b)=> (a.area||'').localeCompare(b.area||'') || a.mod.localeCompare(b.mod) || (a.color||'').localeCompare(b.color||'') || (a.talla||'').localeCompare(b.talla||'')); } const set=new Set([ ...Object.keys(ex), ...COUNTS.keys() ]); set.forEach(vkey=>{ const {mod,color,talla}=splitKey(vkey); if(modF && !mod.toUpperCase().includes(modF)) return; if(colF && !(color||'').toUpperCase().includes(colF)) return; if(talF && !(talla||'').toUpperCase().includes(talF)) return; const theo=Number(ex[vkey]||0); const scan=Number(COUNTS.get(vkey)||0); rows.push({ area:'', mod, color, talla, theo, scan, diff:scan-theo }); }); return rows.sort((a,b)=>a.mod.localeCompare(b.mod) || (a.color||'').localeCompare(b.color||'') || (a.talla||'').localeCompare(b.talla||'')); }
  function loadAggregatesByArea(){
    if(!FOLIO_ID){ AGG_BY_AREA=new Map(); return Promise.resolve(); }
    AGG_BY_AREA=new Map();
    const folio = db.collection('folios').doc(FOLIO_ID).collection('scans');
    const page = 1000;
    function pageFn(query){
      return query.get().then(function(snap){
        if(snap.empty) return;
        snap.forEach(function(doc){ const x=doc.data(); const area=(x.area||'').trim(); const vkey=x.vkey||keyOf(x.mod,x.color,x.talla); if(!AGG_BY_AREA.has(area)) AGG_BY_AREA.set(area,new Map()); const m=AGG_BY_AREA.get(area); m.set(vkey,(m.get(vkey)||0)+1); });
        if(snap.size < page) return;
        const last = snap.docs[snap.size-1];
        return pageFn(folio.orderBy('ts').startAfter(last).limit(page));
      });
    }
    return pageFn(folio.orderBy('ts').limit(page));
  } AGG_BY_AREA=new Map(); const folio=db.collection('folios').doc(FOLIO_ID).collection('scans'); const page=1000; let q=folio.orderBy('ts').limit(page); let last=null; while(true){ const snap=await q.get(); if(snap.empty) break; snap.forEach(doc=>{ const x=doc.data(); const area=(x.area||'').trim(); const vkey=x.vkey||keyOf(x.mod,x.color,x.talla); if(!AGG_BY_AREA.has(area)) AGG_BY_AREA.set(area,new Map()); const m=AGG_BY_AREA.get(area); m.set(vkey,(m.get(vkey)||0)+1); }); if(snap.size<page) break; last=snap.docs[snap.size-1]; q=folio.orderBy('ts').startAfter(last).limit(page); } }
  function renderReport(){ const byArea=$('groupMode').value==='area'; const rows=buildReportRows(byArea); $('reportBody').innerHTML=rows.map(r=>`<tr><td>${esc(r.area||'')}</td><td>${esc(r.mod)}</td><td>${esc(r.color||'')}</td><td>${esc(r.talla||'')}</td><td class=\"text-right\">${r.theo}</td><td class=\"text-right\">${r.scan}</td><td class=\"text-right ${r.diff===0?'':(r.diff>0?'text-emerald-600':'text-red-600')}\">${r.diff}</td></tr>`).join(''); }

  // ===== Inicio =====
  window.addEventListener('DOMContentLoaded',()=>{ const folioParam=new URL(location.href).searchParams.get('folio'); if(folioParam) $('joinFolioId').value=folioParam; cargarCatalogo(false); });
})();
</script>
</body>
</html>
