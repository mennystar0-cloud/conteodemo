<!-- path: /index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conteo Cíclico CKLASS</title>
  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Quagga2 auto-hospedado (debes subir /static/quagga.min.js) -->
  <script src="https://firebasestorage.googleapis.com/v0/b/cklass-conteo-ec4f5.firebasestorage.app/o/static%2Fquagga.min.js?alt=media"></script>
  <!-- XLSX auto-hospedado (debes subir /static/xlsx.full.min.js) -->
  <script src="https://firebasestorage.googleapis.com/v0/b/cklass-conteo-ec4f5.firebasestorage.app/o/static%2Fxlsx.full.min.js?alt=media"></script>
  <!-- Firebase compat (sin módulos) -->
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-storage-compat.js"></script>
  <style>
    .btn{padding:.5rem .75rem;border-radius:.5rem;font-size:.875rem}
    .tab-btn{padding:.5rem .75rem;border-bottom:2px solid transparent}
    .card{background:#fff;padding:1rem;border-radius:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .cam{height:45vh;max-height:400px;background:#000;overflow:hidden;border-radius:1rem}
    th,td{padding:.35rem .5rem;border-bottom:1px solid #eee}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-7xl mx-auto p-4">
  <header class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-xl font-bold">Conteo Cíclico — Catálogo + Existencias + Escaneo</h1>
      <p class="text-sm text-gray-600">Configuración en PC, escaneo simultáneo por folio.</p>
    </div>
    <div class="flex gap-2 items-center">
      <span id="userInfo" class="text-xs text-gray-600">—</span>
      <button id="btnLogin" class="btn bg-emerald-600 text-white">Iniciar sesión</button>
      <button id="btnLogout" class="btn bg-gray-200 hidden">Salir</button>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="flex flex-wrap gap-2 mb-4" id="tabs">
    <button data-tab="importar" class="tab-btn border-blue-600 text-blue-600">Importar</button>
    <button data-tab="existencias" class="tab-btn">Existencias</button>
    <button data-tab="folio" class="tab-btn">Folio</button>
    <button data-tab="escanear" class="tab-btn">Escanear</button>
    <button data-tab="reporte" class="tab-btn">Reporte</button>
    <button data-tab="historial" class="tab-btn">Historial</button>
  </nav>

  <!-- Importar catálogo -->
  <section id="tab-importar" class="block">
    <div class="card">
      <h2 class="font-semibold mb-2">Catálogo maestro (Storage)</h2>
      <p class="text-sm text-gray-600">Lee <code>/static/catalogo-master.xlsx</code> desde tu bucket.
        Columnas recomendadas: <code>CODIGO_BARRA</code>, <code>MOD</code>, <code>COLOR</code>, <code>TALLA</code>.</p>
      <div class="flex gap-2 mt-2">
        <button id="btnRecargarCloud" class="btn bg-blue-600 text-white">Recargar catálogo</button>
        <button id="btnForzarURL" class="btn bg-amber-500 text-white">Forzar URL única</button>
        <span id="importStatus" class="text-sm text-gray-700">—</span>
      </div>
    </div>
  </section>

  <!-- Pegar existencias -->
  <section id="tab-existencias" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Pegar existencias</h2>
      <p class="text-sm text-gray-600">Formato por línea (ejemplo):
        <code>587-12,NEGRO 250 3</code> → <em>MODELO</em>=587-12, <em>COLOR</em>=NEGRO, <em>TALLA</em>=250, <em>CANTIDAD</em>=3.
        También acepta CSV con 4 campos: <code>MODELO,COLOR,TALLA,CANTIDAD</code>.</p>
      <textarea id="existText" rows="8" class="w-full border rounded p-2" placeholder="Ejemplos&#10;587-12,NEGRO 250 3&#10;ABC-01,ROJO 27 2&#10;ABC-01,ROJO,27,2"></textarea>
      <div class="flex gap-2 mt-2 items-center">
        <button id="btnCargarExist" class="btn bg-green-600 text-white">Cargar existencias</button>
        <button id="btnLimpiarExist" class="btn bg-gray-200">Limpiar</button>
        <span id="existStatus" class="text-sm text-gray-700">—</span>
      </div>
    </div>
  </section>

  <!-- Folio -->
  <section id="tab-folio" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Folio</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <input id="folioName" class="border p-2 rounded w-full" placeholder="Nombre del folio" />
          <div class="mt-2 flex gap-2">
            <button id="btnCrearFolio" class="btn bg-green-600 text-white">Crear folio</button>
            <button id="btnCerrarFolio" class="btn bg-gray-200 hidden" title="Solo owner">Cerrar folio</button>
          </div>
        </div>
        <div>
          <input id="joinFolioId" class="border p-2 rounded" placeholder="ID existente" />
          <div class="mt-2 flex gap-2">
            <button id="btnUnirseFolio" class="btn bg-blue-600 text-white">Unirse</button>
            <button id="btnCopiarLink" class="btn bg-gray-200">Copiar link</button>
          </div>
        </div>
      </div>
      <div id="folioStatus" class="text-sm text-gray-600 mt-2">—</div>
    </div>
  </section>

  <!-- Escanear -->
  <section id="tab-escanear" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Escanear</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="cam"><div id="interactive" class="viewport w-full h-full"></div></div>
          <div class="flex gap-2 mt-2 items-center">
            <select id="cameraSelect" class="border p-1"></select>
            <button id="btnRefreshCam" class="btn bg-gray-200">Refrescar cámaras</button>
            <button id="btnTorch" class="btn bg-gray-200">Linterna</button>
            <button id="btnStart" class="btn bg-blue-600 text-white">Iniciar</button>
            <button id="btnStop" class="btn bg-gray-200">Detener</button>
          </div>
        </div>
        <div>
          <label class="text-sm">Área</label>
          <input id="scanArea" class="border p-2 rounded w-full mb-2" placeholder="Ej. Bodega / Piso / Caja" />
          <label class="text-sm">Entrada manual</label>
          <input id="manualCode" class="border p-2 rounded w-full" placeholder="Pega un código y Enter" />
          <div id="lastItem" class="mt-2 text-sm text-gray-700">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Reporte -->
  <section id="tab-reporte" class="hidden">
    <div class="card">
      <div class="flex gap-2 items-center mb-2">
        <h2 class="font-semibold">Reporte</h2>
        <select id="groupMode" class="ml-auto border p-1 rounded text-sm">
          <option value="general">General</option>
          <option value="area">Agrupar por área</option>
        </select>
        <button id="btnRefrescarReporte" class="btn bg-blue-600 text-white">Refrescar</button>
        <button id="btnExportarCSV" class="btn bg-gray-200">Exportar CSV</button>
      </div>
      <div class="overflow-auto max-h-[60vh]">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr>
              <th class="text-left">Área</th>
              <th class="text-left">Modelo</th>
              <th class="text-left">Color</th>
              <th class="text-left">Talla</th>
              <th class="text-right">Teórico</th>
              <th class="text-right">Escaneado</th>
              <th class="text-right">Diferencia</th>
            </tr>
          </thead>
          <tbody id="reportBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Historial -->
  <section id="tab-historial" class="hidden">
    <div class="card">
      <h2 class="font-semibold mb-2">Historial</h2>
      <div class="overflow-auto max-h-[60vh]">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr>
              <th class="text-left">Fecha</th>
              <th class="text-left">Área</th>
              <th class="text-left">Código</th>
              <th class="text-left">Modelo</th>
              <th class="text-left">Color</th>
              <th class="text-left">Talla</th>
              <th class="text-left">Usuario</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  // ===== Firebase init (usa exactamente tu config de la consola) =====
  const firebaseConfig = {
    apiKey: "AIzaSyBe23iKn2bl0YMxsXUiTN5SkUrD9Vhvfo",
    authDomain: "cklass-conteo-ec4f5.firebaseapp.com",
    projectId: "cklass-conteo-ec4f5",
    storageBucket: "cklass-conteo-ec4f5.firebasestorage.app",
    messagingSenderId: "148726861241",
    appId: "1:148726861241:web:592f683e941d13d2829e68",
    measurementId: "G-EMVHW8SQMN"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();
  const storage=firebase.storage();
  db.enablePersistence().catch(()=>{});

  // ===== Helpers =====
  const $=id=>document.getElementById(id);
  const on=(id,ev,fn)=>{const n=$(id); if(n) n.addEventListener(ev,fn);};
  const esc=s=>String(s).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
  const fmt=d=>{const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`};
  const keyOf=(mod,color,talla)=>`${(mod||'').trim()}|${(color||'').trim()}|${(talla||'').trim()}`;
  const splitKey=k=>{const [mod,color,talla]=String(k||'').split('|'); return {mod,color,talla};};

  // ===== Tabs =====
  function showTab(name){
    ['importar','existencias','folio','escanear','reporte','historial'].forEach(t=>{
      const el=$('tab-'+t); if(!el) return; el.classList.toggle('hidden',t!==name); el.classList.toggle('block',t===name);
    });
  }
  window.addEventListener('DOMContentLoaded',()=>{
    const tabs=document.querySelectorAll('#tabs [data-tab]');
    tabs.forEach(btn=>btn.addEventListener('click',()=>{
      tabs.forEach(b=>b.classList.remove('border-blue-600','text-blue-600'));
      btn.classList.add('border-blue-600','text-blue-600');
      showTab(btn.dataset.tab);
    }));
    showTab('importar');
  });

  // ===== Auth =====
  on('btnLogin','click',async()=>{ try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(e){ alert('No se pudo iniciar sesión'); console.error(e);} });
  on('btnLogout','click',()=>auth.signOut());
  auth.onAuthStateChanged(u=>{
    $('btnLogin').classList.toggle('hidden',!!u);
    $('btnLogout').classList.toggle('hidden',!u);
    $('userInfo').textContent = u? (u.email||u.uid) : '—';
  });

  // ===== Catálogo (Storage) =====
  const GS_PATH = 'gs://cklass-conteo-ec4f5.firebasestorage.app/static/catalogo-master.xlsx';
  let CATALOGO = { byBarcode:new Map(), byVariant:new Map() };
  const canon = s => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toUpperCase();

  async function cargarCatalogoStorage(force=false){
    try{
      $('importStatus').textContent='Descargando…';
      const ref = storage.refFromURL(GS_PATH);
      const url = await ref.getDownloadURL();
      const finalUrl = force ? `${url}${url.includes('?')?'&':'?'}v=${Date.now()}` : url;
      const resp=await fetch(finalUrl,{cache:'no-store'});
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const ab=await resp.arrayBuffer();
      if(!window.XLSX) throw new Error('XLSX no cargó');
      const wb=XLSX.read(ab,{type:'array'});
      const sh=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
      CATALOGO = buildCatalog(rows);
      $('importStatus').textContent=`Catálogo OK: ${rows.length-1} filas (hoja: ${wb.SheetNames[0]})`;
    }catch(e){ console.error(e); $('importStatus').textContent='❌ '+(e.message||e); }
  }
  on('btnRecargarCloud','click',()=>cargarCatalogoStorage(false));
  on('btnForzarURL','click',()=>cargarCatalogoStorage(true));

  function buildCatalog(rows){
    const res={ byBarcode:new Map(), byVariant:new Map() };
    const H=(rows[0]||[]).map(canon);
    const iCode=H.indexOf('CODIGO_BARRA');
    const iMod =H.indexOf('MOD');
    const iColor=H.indexOf('COLOR');
    const iTalla=H.indexOf('TALLA');
    for(let r=1;r<rows.length;r++){
      const row=rows[r]||[];
      const code=String(row[iCode]||'').trim();
      const mod =String(row[iMod]||'').trim();
      const color=String(row[iColor]||'').trim();
      const talla=String(row[iTalla]||'').trim();
      if(!code||!mod) continue;
      const vkey=keyOf(mod,color,talla);
      const item={mod,color,talla,vkey};
      res.byBarcode.set(code,item);
      if(!res.byVariant.has(vkey)) res.byVariant.set(vkey,item);
    }
    return res;
  }

  // ===== Folio =====
  let FOLIO_ID=null; let FOLIO_DOC=null; let COUNTS=new Map();
  let docUnsub=null, countsUnsub=null, scansUnsub=null;

  async function crearFolio(){
    const u=auth.currentUser; if(!u) return alert('Inicia sesión');
    const name=($('#folioName').value||'Cíclico').trim();
    const ref=db.collection('folios').doc();
    await ref.set({ name, ownerUid:u.uid, members:[u.uid], state:'open', existenciasMap:{}, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    await activarFolio(ref.id);
  }
  async function activarFolio(id){
    const u=auth.currentUser; if(!u) return alert('Inicia sesión');
    FOLIO_ID=id;
    if(docUnsub) docUnsub(); if(countsUnsub) countsUnsub(); if(scansUnsub) scansUnsub();
    docUnsub = db.collection('folios').doc(id).onSnapshot(snap=>{
      if(!snap.exists) return; FOLIO_DOC=snap.data();
      $('folioStatus').textContent=`Folio: ${id} — ${FOLIO_DOC.name}`;
      $('joinFolioId').value=id;
      const isOwner = u.uid===FOLIO_DOC.ownerUid;
      const closeBtn=$('btnCerrarFolio'); closeBtn.disabled=!isOwner; closeBtn.classList.toggle('hidden',!isOwner);
    });
    subscribeCounts();
    subscribeScans();
  }
  async function unirseFolio(){
    const u=auth.currentUser; if(!u) return alert('Inicia sesión');
    const id=($('#joinFolioId').value||'').trim(); if(!id) return;
    const ref=db.collection('folios').doc(id);
    const snap=await ref.get(); if(!snap.exists) return alert('No existe');
    await ref.update({ members: firebase.firestore.FieldValue.arrayUnion(u.uid) });
    await activarFolio(id);
  }
  on('btnCrearFolio','click',crearFolio);
  on('btnUnirseFolio','click',unirseFolio);
  on('btnCopiarLink','click',()=>{ if(!FOLIO_ID) return; const u=new URL(location.href); u.searchParams.set('folio',FOLIO_ID); navigator.clipboard.writeText(u.toString()); alert('Link copiado'); });
  on('btnCerrarFolio','click',async()=>{ const u=auth.currentUser; if(!u||!FOLIO_ID) return; const snap=await db.collection('folios').doc(FOLIO_ID).get(); if(!snap.exists) return; if(snap.data().ownerUid!==u.uid) return alert('Solo owner'); await db.collection('folios').doc(FOLIO_ID).update({state:'closed'}); alert('Folio cerrado'); });

  // ===== Existencias (pegar) =====
  on('btnLimpiarExist','click',()=>{ $('existText').value=''; $('existStatus').textContent='—'; });
  on('btnCargarExist','click',async()=>{
    try{
      if(!FOLIO_ID) return alert('Activa o crea un folio primero');
      const txt=$('existText').value||'';
      const map=parseExistencias(txt);
      if(Object.keys(map).length===0) return alert('No se detectaron líneas válidas');
      await db.collection('folios').doc(FOLIO_ID).set({ existenciasMap: map, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },{merge:true});
      $('existStatus').textContent=`Cargadas ${Object.keys(map).length} variantes`;
    }catch(e){ console.error(e); $('existStatus').textContent='❌ '+(e.message||e); }
  });

  function parseExistencias(text){
    const out={};
    const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    for(const ln of lines){
      // 1) Formato: MODELO,COLOR TALLA CANTIDAD  (ej: 587-12,NEGRO 250 3)
      let m = ln.match(/^([^,]+),\s*([^,\s]+)\s+([\w\.\-]+)\s+(\d+)$/i);
      if(!m){
        // 2) CSV estricto: MODELO,COLOR,TALLA,CANTIDAD
        const p = ln.split(',').map(s=>s.trim());
        if(p.length>=4 && /^\d+$/.test(p[p.length-1])){
          const mod=p[0], color=p[1], talla=p[2], qty=parseInt(p[p.length-1]);
          const k=keyOf(mod,color,talla); out[k]=qty; continue;
        }
      } else {
        const [,mod,color,talla,qty]=m; const k=keyOf(mod,color,talla); out[k]=parseInt(qty,10); continue;
      }
      // Si nada coincide, ignora línea
    }
    return out;
  }

  // ===== Realtime =====
  function subscribeCounts(){
    if(countsUnsub) countsUnsub(); COUNTS.clear();
    if(!FOLIO_ID) return;
    countsUnsub = db.collection('folios').doc(FOLIO_ID).collection('counts').onSnapshot(snap=>{
      snap.forEach(d=>COUNTS.set(d.id, d.data().qty||0));
    });
  }
  function subscribeScans(){
    if(scansUnsub) scansUnsub();
    if(!FOLIO_ID) return;
    scansUnsub = db.collection('folios').doc(FOLIO_ID).collection('scans').orderBy('ts','desc').limit(500).onSnapshot(snap=>{
      const rows=[]; snap.forEach(d=>{const x=d.data(); const dt=x.ts?.toDate?x.ts.toDate():new Date(); rows.push(`<tr><td>${fmt(dt)}</td><td>${esc(x.area||'')}</td><td>${esc(x.code)}</td><td>${esc(x.mod||'')}</td><td>${esc(x.color||'')}</td><td>${esc(x.talla||'')}</td><td>${esc(x.user||'')}</td></tr>`);});
      $('historyBody').innerHTML=rows.join('');
    });
  }

  // ===== GS1 mínima =====
  function computeEAN13CheckDigit(d12){const a=d12.split('').map(Number);let s=0;for(let i=0;i<12;i++) s+=a[i]*(i%2?3:1);return String((10-(s%10))%10)}
  function toEAN13FromGTIN14(gt){if(!/^\d{14}$/.test(gt)) return null; const b=gt.slice(1,13); return b+computeEAN13CheckDigit(b)}
  function normalizeBarcode(raw){const s=String(raw).trim(); if(/^\d{13}$/.test(s)){const cd=computeEAN13CheckDigit(s.slice(0,12)); return {ean13:s.slice(0,12)+cd};} if(/^\d{12}$/.test(s)) return {ean13:'0'+s}; if(/^\d{14}$/.test(s)) return {ean13:toEAN13FromGTIN14(s)}; return {raw:s};}

  // ===== Escáner =====
  let scanning=false; let activeTrack=null; let TORCH=false;
  on('btnRefreshCam','click',async()=>{ const list=await navigator.mediaDevices.enumerateDevices(); const cams=list.filter(d=>d.kind==='videoinput'); $('cameraSelect').innerHTML=cams.map(d=>`<option value="${d.deviceId}">${d.label||('Cam '+d.deviceId.slice(-4))}</option>`).join(''); });
  on('btnStart','click',startScanner);
  on('btnStop','click',stopScanner);
  on('btnTorch','click',async()=>{ try{ activeTrack = activeTrack || document.querySelector('#interactive video')?.srcObject?.getVideoTracks?.()[0]; await activeTrack.applyConstraints({advanced:[{torch: !(TORCH=!TORCH)}]}); }catch{ alert('Linterna no soportada'); }});
  on('manualCode','keydown',e=>{ if(e.key==='Enter'){ const v=e.currentTarget.value.trim(); if(v) handleBarcode(v); e.currentTarget.value=''; }});

  async function startScanner(){
    if(scanning) return; if(!window.Quagga) return alert('Quagga no disponible');
    scanning=true;
    const devId=$('cameraSelect').value || undefined;
    try{
      await Quagga.init({ inputStream:{ name:'Live', type:'LiveStream', target: document.querySelector('#interactive'), constraints: devId? {deviceId:devId}:{ facingMode:'environment'} }, decoder:{ readers:['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader'] }, locate:true });
      Quagga.start();
      setTimeout(()=>{ try{ const v=document.querySelector('#interactive video'); activeTrack=v?.srcObject?.getVideoTracks?.()[0]; }catch{} },300);
      Quagga.onDetected(res=>{ const code=(res?.codeResult?.code||'').trim(); if(code) handleBarcode(code); });
    }catch(e){ console.error(e); scanning=false; alert('No se pudo iniciar cámara'); }
  }
  function stopScanner(){ try{ Quagga.stop(); }catch{} scanning=false; activeTrack=null; TORCH=false; }

  async function handleBarcode(code){
    if(!FOLIO_ID) return alert('Sin folio'); if(CATALOGO.byBarcode.size===0) return alert('Catálogo no cargado');
    const n=normalizeBarcode(code); const key=n.ean13||code; const item = CATALOGO.byBarcode.get(key)||CATALOGO.byBarcode.get(String(code));
    if(!item){ $('lastItem').textContent='No encontrado: '+code; return; }
    const area = ($('#scanArea').value||'').trim();
    await registrarScan(item, code, area);
    $('lastItem').textContent = `✔ ${item.mod} ${item.color||''} ${item.talla||''} (${key}) ${area? '— '+area:''}`;
  }
  async function registrarScan(item, code, area){
    const u=auth.currentUser; const folio=db.collection('folios').doc(FOLIO_ID);
    const vkey=item.vkey||keyOf(item.mod,item.color,item.talla);
    await Promise.all([
      folio.collection('counts').doc(vkey).set({ qty: firebase.firestore.FieldValue.increment(1) },{merge:true}),
      folio.collection('scans').add({ code, mod:item.mod, color:item.color||'', talla:item.talla||'', vkey, area, user:(u?.email||u?.uid||''), ts: firebase.firestore.FieldValue.serverTimestamp() })
    ]).catch(e=>{console.error(e); alert('Error registrando');});
  }

  // ===== Reporte =====
  // agregados exactos por área (area -> Map(vkey -> qty))
  let AGG_BY_AREA = new Map();

  on('btnRefrescarReporte','click', async ()=>{ await loadAggregatesByArea(); renderReport(); });
  on('btnExportarCSV','click',()=>{
    const rows = buildReportRows($('#groupMode').value==='area');
    const csv = ['Area,Modelo,Color,Talla,Teorico,Escaneado,Diferencia']
      .concat(rows.map(r=>[r.area||'',r.mod,r.color||'',r.talla||'',r.theo,r.scan,r.diff].join(',')))
      .join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`reporte_${FOLIO_ID||'sin_folio'}.csv`; a.click(); URL.revokeObjectURL(a.href);
  });

  function buildReportRows(byArea){
    const ex = (FOLIO_DOC?.existenciasMap)||{};
    const rows=[];
    if(byArea){
      AGG_BY_AREA.forEach((mods, area)=>{
        mods.forEach((scan, vkey)=>{
          const {mod,color,talla}=splitKey(vkey);
          const theo = Number(ex[vkey]||0);
          rows.push({ area, mod, color, talla, theo, scan, diff: scan - theo });
        });
      });
      return rows.sort((a,b)=> (a.area||'').localeCompare(b.area||'') || a.mod.localeCompare(b.mod) || (a.color||'').localeCompare(b.color||'') || (a.talla||'').localeCompare(b.talla||''));
    }
    const set=new Set([ ...Object.keys(ex), ...COUNTS.keys() ]);
    set.forEach(vkey=>{ const theo=Number(ex[vkey]||0); const scan=Number(COUNTS.get(vkey)||0); const {mod,color,talla}=splitKey(vkey); rows.push({ area:'', mod, color, talla, theo, scan, diff:scan-theo }); });
    return rows.sort((a,b)=>a.mod.localeCompare(b.mod) || (a.color||'').localeCompare(b.color||'') || (a.talla||'').localeCompare(b.talla||''));
  }

  async function loadAggregatesByArea(){
    if(!FOLIO_ID){ AGG_BY_AREA=new Map(); return; }
    AGG_BY_AREA=new Map();
    const folio = db.collection('folios').doc(FOLIO_ID).collection('scans');
    const page = 1000; // pagina de 1000
    let q = folio.orderBy('ts').limit(page);
    let last=null;
    while(true){
      const snap = await q.get();
      if(snap.empty) break;
      snap.forEach(doc=>{
        const x=doc.data();
        const area=(x.area||'').trim();
        const vkey=x.vkey || keyOf(x.mod,x.color,x.talla);
        if(!AGG_BY_AREA.has(area)) AGG_BY_AREA.set(area,new Map());
        const m=AGG_BY_AREA.get(area);
        m.set(vkey,(m.get(vkey)||0)+1);
      });
      if(snap.size < page) break;
      last = snap.docs[snap.size-1];
      q = folio.orderBy('ts').startAfter(last).limit(page);
    }
  }

  function renderReport(){
    const byArea=$('#groupMode').value==='area';
    const rows=buildReportRows(byArea);
    $('reportBody').innerHTML = rows.map(r=>`<tr><td>${esc(r.area||'')}</td><td>${esc(r.mod)}</td><td>${esc(r.color||'')}</td><td>${esc(r.talla||'')}</td><td class=\"text-right\">${r.theo}</td><td class=\"text-right\">${r.scan}</td><td class=\"text-right ${r.diff===0?'':(r.diff>0?'text-emerald-600':'text-red-600')}\">${r.diff}</td></tr>`).join('');
  }

  // ===== Inicio =====
  window.addEventListener('DOMContentLoaded',()=>{ cargarCatalogoStorage(false); const folioParam=new URL(location.href).searchParams.get('folio'); if(folioParam) { $('#joinFolioId').value=folioParam; } });
})();
</script>
</body>
</html>
