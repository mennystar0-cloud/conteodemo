<!-- path: /index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conteo Cíclico CKLASS</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-storage-compat.js"></script>
  <style>
    .btn{padding:.5rem .75rem;border-radius:.5rem;font-size:.875rem}
    .tab-btn{padding:.5rem .75rem;border-bottom:2px solid transparent}
    .card{background:#fff;padding:1rem;border-radius:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .cam{height:45vh;max-height:400px;background:#000;overflow:hidden;border-radius:1rem}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-6xl mx-auto p-4">
  <header class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-xl font-bold">Conteo Cíclico — Catálogo + Existencias + Escaneo</h1>
      <p class="text-sm text-gray-600">Configuración en PC, escaneo en móviles con folio.</p>
    </div>
    <div>
      <button id="btnLogin" class="btn bg-emerald-600 text-white">Iniciar sesión</button>
      <button id="btnLogout" class="btn bg-gray-200 hidden">Salir</button>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="flex gap-2 mb-4" id="tabs">
    <button data-tab="importar" class="tab-btn border-blue-600 text-blue-600">Importar</button>
    <button data-tab="folio" class="tab-btn">Folio</button>
    <button data-tab="escanear" class="tab-btn">Escanear</button>
    <button data-tab="reporte" class="tab-btn">Reporte</button>
    <button data-tab="historial" class="tab-btn">Historial</button>
    <button data-tab="admin" class="tab-btn">Admin</button>
  </nav>

  <section id="tab-importar">Importar catálogo aquí…</section>
  <section id="tab-folio" class="hidden">Configura folio aquí…</section>
  <section id="tab-escanear" class="hidden">
    <div class="cam"><video id="video" autoplay></video></div>
    <div class="flex gap-2 mt-2">
      <select id="cameraSelect" class="border p-1"></select>
      <button id="btnRefreshCam" class="btn bg-gray-200">Refrescar cámaras</button>
      <button id="btnTorch" class="btn bg-gray-200">Linterna</button>
      <button id="btnStart" class="btn bg-blue-600 text-white">Iniciar escaneo</button>
    </div>
    <div id="lastItem" class="mt-2 text-sm text-gray-700">—</div>
  </section>
  <section id="tab-reporte" class="hidden">Reporte aquí…</section>
  <section id="tab-historial" class="hidden">Historial aquí…</section>
  <section id="tab-admin" class="hidden">
    <button id="btnZip" class="btn bg-purple-600 text-white">Descargar ZIP (admin)</button>
    <button id="btnClose" class="btn bg-red-600 text-white">Cerrar folio</button>
  </section>
</div>

<script>
(function(){
  // === Firebase init (compat) ===
  const firebaseConfig = {
    apiKey: "AIzaSyBe23iKn2bl0YMxsXUiTN5SkUrD9Vhvfo",
    authDomain: "cklass-conteo-ec4f5.firebaseapp.com",
    projectId: "cklass-conteo-ec4f5",
    storageBucket: "cklass-conteo-ec4f5.appspot.com",
    messagingSenderId: "148726861241",
    appId: "1:148726861241:web:592f683e941d13d2829e68",
    measurementId: "G-EMVHW8SQMN"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  db.enablePersistence().catch(()=>{});

  // Helpers
  const $ = id=>document.getElementById(id);
  const setText=(id,t)=>{const n=$(id); if(n) n.textContent=t;};

  // Tabs
  window.addEventListener('DOMContentLoaded',()=>{
    const tabs=document.querySelectorAll('#tabs [data-tab]');
    tabs.forEach(btn=>{
      btn.addEventListener('click',()=>{
        tabs.forEach(b=>b.classList.remove('border-blue-600','text-blue-600'));
        btn.classList.add('border-blue-600','text-blue-600');
        ['importar','folio','escanear','reporte','historial','admin'].forEach(t=>{
          const s=document.getElementById('tab-'+t);
          if(s) s.classList.add('hidden');
        });
        const active=document.getElementById('tab-'+btn.dataset.tab);
        if(active) active.classList.remove('hidden');
      });
    });
  });

  // Auth
  $('btnLogin').addEventListener('click',async()=>{
    const provider=new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  });
  $('btnLogout').addEventListener('click',()=>auth.signOut());
  auth.onAuthStateChanged(user=>{
    $('btnLogin').classList.toggle('hidden',!!user);
    $('btnLogout').classList.toggle('hidden',!user);
    if(user){ cargarCatalogo(); }
  });

  // Catalog desde Storage/static/catalogo-master.xlsx
  async function cargarCatalogo(){
    try{
      const ref=storage.ref('static/catalogo-master.xlsx');
      const url=await ref.getDownloadURL();
      const resp=await fetch(url);
      if(!resp.ok) throw new Error(resp.statusText);
      setText('lastItem','Catálogo cargado ✅');
    }catch(e){
      console.error(e);
      setText('lastItem','❌ Error cargando catálogo: '+(e.message||e));
    }
  }

  // Escaneo básico
  let stream;
  $('btnRefreshCam').addEventListener('click',async()=>{
    const devices=await navigator.mediaDevices.enumerateDevices();
    $('cameraSelect').innerHTML='';
    devices.filter(d=>d.kind==='videoinput').forEach(d=>{
      const opt=document.createElement('option'); opt.value=d.deviceId; opt.text=d.label||d.deviceId;
      $('cameraSelect').appendChild(opt);
    });
  });
  $('btnStart').addEventListener('click',async()=>{
    if(stream){stream.getTracks().forEach(t=>t.stop());}
    stream=await navigator.mediaDevices.getUserMedia({video:{deviceId:$('cameraSelect').value}});
    $('video').srcObject=stream;
  });
  $('btnTorch').addEventListener('click',()=>{
    if(!stream) return;
    const track=stream.getVideoTracks()[0];
    track.applyConstraints({advanced:[{torch:true}]}).catch(()=>alert('No soportado'));
  });

  // Admin botones
  $('btnZip').addEventListener('click',()=>alert('Descarga ZIP simulada'));
  $('btnClose').addEventListener('click',()=>alert('Folio cerrado'));
})();
</script>
</body>
</html>
